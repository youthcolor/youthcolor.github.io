<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="youthcolor's github blog"><title>R使用keras包和lime包实现图像分类并添加解释 | Geekdreams</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">R使用keras包和lime包实现图像分类并添加解释</h1><a id="logo" href="/.">Geekdreams</a><p class="description">Nothing is difficult to the man who will try.</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">R使用keras包和lime包实现图像分类并添加解释</h1><div class="post-meta"><a href="/2018/08/22/R使用keras包和lime包实现图像分类并添加解释/#comments" class="comment-count"><a id="uyan_count_unit" href="/2018/08/22/R使用keras包和lime包实现图像分类并添加解释/"></a>留言</a><p><span class="date">Aug 22, 2018</span><span><a href="/categories/R/" class="category">R</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p>告诉大家一个好消息，我已经使用上keras和TensorFlow了，喜欢它简单直接的建模方式。</p>
<h2 id="为不同类型的水果建立图像分类器"><a href="#为不同类型的水果建立图像分类器" class="headerlink" title="为不同类型的水果建立图像分类器"></a>为不同类型的水果建立图像分类器</h2><p>本实验的目的是为不同类型的水果建立图像分类器，再次为它建模的快速且简单而惊讶到了，大约100行代码跑了不到一个小时时间！（主代码部分已经做了简单的注释以方便阅读）</p>
<p>这就是我为什么要分享使用keras的原因。</p>
<a id="more"></a>
<h2 id="代码开始"><a href="#代码开始" class="headerlink" title="代码开始"></a>代码开始</h2><p>如果你之前还没有安装keras，请参照<a href="https://keras.rstudio.com/" target="_blank" rel="external">RStudio’s keras site</a></p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(keras)</div></pre></td></tr></table></figure>
<p>本实验的数据集来自kaggle的<a href="https://www.kaggle.com/moltean/fruits/data" target="_blank" rel="external">fruit images dataset</a>。我已经下载并解压了这个数据集，由于我不想对每个水果都建模，因此我只是选取了其中的16个种类的水果进行了建模。</p>
<p>为了尽可能简单，我一开始时定义了几个参数。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 要建模的水果列表</span></div><div class="line">fruit_list &lt;- c(<span class="string">"Kiwi"</span>, <span class="string">"Banana"</span>, <span class="string">"Apricot"</span>, <span class="string">"Avocado"</span>, <span class="string">"Cocos"</span>, <span class="string">"Clementine"</span>, <span class="string">"Mandarine"</span>, <span class="string">"Orange"</span>,</div><div class="line">                <span class="string">"Limes"</span>, <span class="string">"Lemon"</span>, <span class="string">"Peach"</span>, <span class="string">"Plum"</span>, <span class="string">"Raspberry"</span>, <span class="string">"Strawberry"</span>, <span class="string">"Pineapple"</span>, <span class="string">"Pomegranate"</span>)</div><div class="line"></div><div class="line"><span class="comment"># 输出水果类别的数量</span></div><div class="line">output_n &lt;- length(fruit_list)</div><div class="line"></div><div class="line"><span class="comment"># 图像大小缩小至20*20像素 (原始图像尺寸为100*100像素)</span></div><div class="line">img_width &lt;- <span class="number">20</span></div><div class="line">img_height &lt;- <span class="number">20</span></div><div class="line">target_size &lt;- c(img_width, img_height)</div><div class="line"></div><div class="line"><span class="comment"># RGB = 3 通道</span></div><div class="line">channels &lt;- <span class="number">3</span></div><div class="line"></div><div class="line"><span class="comment"># 图片文件夹路径</span></div><div class="line">train_image_files_path &lt;- <span class="string">"C:/Users/Administrator/Desktop/fruits-360/Training/"</span></div><div class="line">valid_image_files_path &lt;- <span class="string">"C:/Users/Administrator/Desktop/fruits-360/Test/"</span></div></pre></td></tr></table></figure>
<h2 id="加载图片"><a href="#加载图片" class="headerlink" title="加载图片"></a>加载图片</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 可选择的数据参数</span></div><div class="line">train_data_gen = image_data_generator(</div><div class="line">  rescale = <span class="number">1</span>/<span class="number">255</span> <span class="comment">#,</span></div><div class="line">  <span class="comment">#rotation_range = 40,</span></div><div class="line">  <span class="comment">#width_shift_range = 0.2,</span></div><div class="line">  <span class="comment">#height_shift_range = 0.2,</span></div><div class="line">  <span class="comment">#shear_range = 0.2,</span></div><div class="line">  <span class="comment">#zoom_range = 0.2,</span></div><div class="line">  <span class="comment">#horizontal_flip = TRUE,</span></div><div class="line">  <span class="comment">#fill_mode = "nearest"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment"># 验证数据不应该加入这些参数，除了尺寸上的缩放</span></div><div class="line">valid_data_gen &lt;- image_data_generator(</div><div class="line">  rescale = <span class="number">1</span>/<span class="number">255</span></div><div class="line">  )</div></pre></td></tr></table></figure>
<h2 id="现在将图片载入内存并调增大小"><a href="#现在将图片载入内存并调增大小" class="headerlink" title="现在将图片载入内存并调增大小"></a>现在将图片载入内存并调增大小</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 训练集图片</span></div><div class="line">train_image_array_gen &lt;- flow_images_from_directory(train_image_files_path, </div><div class="line">                                          train_data_gen,</div><div class="line">                                          target_size = target_size,</div><div class="line">                                          class_mode = <span class="string">"categorical"</span>,</div><div class="line">                                          classes = fruit_list,</div><div class="line">                                          seed = <span class="number">42</span>)</div><div class="line"></div><div class="line"><span class="comment"># 验证集图片</span></div><div class="line">valid_image_array_gen &lt;- flow_images_from_directory(valid_image_files_path, </div><div class="line">                                          valid_data_gen,</div><div class="line">                                          target_size = target_size,</div><div class="line">                                          class_mode = <span class="string">"categorical"</span>,</div><div class="line">                                          classes = fruit_list,</div><div class="line">                                          seed = <span class="number">42</span>)</div><div class="line">cat(<span class="string">"Number of images per class:"</span>)  </div><div class="line"><span class="comment">## Number of images per class:</span></div><div class="line">table(factor(train_image_array_gen$classes))</div><div class="line"><span class="comment">##   0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15 </span></div><div class="line"><span class="comment">## 466 490 492 427 490 490 490 479 490 492 492 447 490 492 490 492</span></div><div class="line">cat(<span class="string">"\nClass label vs index mapping:\n"</span>)</div><div class="line"><span class="comment">## Class label vs index mapping:</span></div><div class="line">train_image_array_gen$class_indices</div><div class="line"><span class="comment">## $Lemon</span></div><div class="line"><span class="comment">## [1] 9</span></div><div class="line"><span class="comment">## </span></div><div class="line"><span class="comment">## $Peach</span></div><div class="line"><span class="comment">## [1] 10</span></div><div class="line"><span class="comment">## </span></div><div class="line"><span class="comment">## $Limes</span></div><div class="line"><span class="comment">## [1] 8</span></div><div class="line"><span class="comment">## </span></div><div class="line"><span class="comment">## $Apricot</span></div><div class="line"><span class="comment">## [1] 2</span></div><div class="line"><span class="comment">## </span></div><div class="line"><span class="comment">## $Plum</span></div><div class="line"><span class="comment">## [1] 11</span></div><div class="line"><span class="comment">## </span></div><div class="line"><span class="comment">## $Avocado</span></div><div class="line"><span class="comment">## [1] 3</span></div><div class="line"><span class="comment">## </span></div><div class="line"><span class="comment">## $Strawberry</span></div><div class="line"><span class="comment">## [1] 13</span></div><div class="line"><span class="comment">## </span></div><div class="line"><span class="comment">## $Pineapple</span></div><div class="line"><span class="comment">## [1] 14</span></div><div class="line"><span class="comment">## </span></div><div class="line"><span class="comment">## $Orange</span></div><div class="line"><span class="comment">## [1] 7</span></div><div class="line"><span class="comment">## </span></div><div class="line"><span class="comment">## $Mandarine</span></div><div class="line"><span class="comment">## [1] 6</span></div><div class="line"><span class="comment">## </span></div><div class="line"><span class="comment">## $Banana</span></div><div class="line"><span class="comment">## [1] 1</span></div><div class="line"><span class="comment">## </span></div><div class="line"><span class="comment">## $Clementine</span></div><div class="line"><span class="comment">## [1] 5</span></div><div class="line"><span class="comment">## </span></div><div class="line"><span class="comment">## $Kiwi</span></div><div class="line"><span class="comment">## [1] 0</span></div><div class="line"><span class="comment">## </span></div><div class="line"><span class="comment">## $Cocos</span></div><div class="line"><span class="comment">## [1] 4</span></div><div class="line"><span class="comment">## </span></div><div class="line"><span class="comment">## $Pomegranate</span></div><div class="line"><span class="comment">## [1] 15</span></div><div class="line"><span class="comment">## </span></div><div class="line"><span class="comment">## $Raspberry</span></div><div class="line"><span class="comment">## [1] 12</span></div><div class="line">fruits_classes_indices &lt;- train_image_array_gen$class_indices</div><div class="line">save(fruits_classes_indices, file = <span class="string">"C:/Users/Administrator/Desktop/fruits-360/fruits_classes_indices.RData"</span>)</div></pre></td></tr></table></figure>
<h2 id="定义模型"><a href="#定义模型" class="headerlink" title="定义模型"></a>定义模型</h2><p>接下来，我们定义keras模型。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 训练集样本的数量</span></div><div class="line">train_samples &lt;- train_image_array_gen$n</div><div class="line"><span class="comment"># 验证集样本的数量</span></div><div class="line">valid_samples &lt;- valid_image_array_gen$n</div><div class="line"><span class="comment"># 定义batch大小和epochs数量</span></div><div class="line">batch_size &lt;- <span class="number">32</span></div><div class="line">epochs &lt;- <span class="number">10</span></div></pre></td></tr></table></figure>
<p>这里我使用的模型是一个简单序列的卷及神经网络，它的隐藏层包含2个卷积层，1个池化层，一个密集层。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 初始化模型</span></div><div class="line">model &lt;- keras_model_sequential()</div><div class="line"></div><div class="line"><span class="comment"># 添加层</span></div><div class="line">model %&gt;%</div><div class="line">  layer_conv_2d(filter = <span class="number">32</span>, kernel_size = c(<span class="number">3</span>,<span class="number">3</span>), padding = <span class="string">"same"</span>, input_shape = c(img_width, img_height, channels)) %&gt;%</div><div class="line">  layer_activation(<span class="string">"relu"</span>) %&gt;%</div><div class="line">  </div><div class="line">  <span class="comment"># 第二个隐藏层</span></div><div class="line">  layer_conv_2d(filter = <span class="number">16</span>, kernel_size = c(<span class="number">3</span>,<span class="number">3</span>), padding = <span class="string">"same"</span>) %&gt;%</div><div class="line">  layer_activation_leaky_relu(<span class="number">0.5</span>) %&gt;%</div><div class="line">  layer_batch_normalization() %&gt;%</div><div class="line"></div><div class="line">  <span class="comment"># 使用最大池化</span></div><div class="line">  layer_max_pooling_2d(pool_size = c(<span class="number">2</span>,<span class="number">2</span>)) %&gt;%</div><div class="line">  layer_dropout(<span class="number">0.25</span>) %&gt;%</div><div class="line">  </div><div class="line">  <span class="comment"># 扁平最大化过滤输出特征向量并喂给密集层</span></div><div class="line">  layer_flatten() %&gt;%</div><div class="line">  layer_dense(<span class="number">100</span>) %&gt;%</div><div class="line">  layer_activation(<span class="string">"relu"</span>) %&gt;%</div><div class="line">  layer_dropout(<span class="number">0.5</span>) %&gt;%</div><div class="line"></div><div class="line">  <span class="comment"># 再喂给输出层</span></div><div class="line">  layer_dense(output_n) %&gt;% </div><div class="line">  layer_activation(<span class="string">"softmax"</span>)</div><div class="line"></div><div class="line"><span class="comment"># 编译</span></div><div class="line">model %&gt;% compile(</div><div class="line">  loss = <span class="string">"categorical_crossentropy"</span>,</div><div class="line">  optimizer = optimizer_rmsprop(lr = <span class="number">0.0001</span>, decay = <span class="number">1e-6</span>),</div><div class="line">  metrics = <span class="string">"accuracy"</span></div><div class="line">)</div></pre></td></tr></table></figure></p>
<h2 id="拟合模型"><a href="#拟合模型" class="headerlink" title="拟合模型"></a>拟合模型</h2><p>前面我已经使用了image_data_generator()和flow_images_from_directory()这两个函数，在此，我将使用fit_generator()函数跑训练集。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 拟合</span></div><div class="line">hist &lt;- model %&gt;% fit_generator(</div><div class="line">  <span class="comment"># 训练数据</span></div><div class="line">  train_image_array_gen,</div><div class="line">  </div><div class="line">  <span class="comment"># epochs</span></div><div class="line">  steps_per_epoch = as.integer(train_samples / batch_size), </div><div class="line">  epochs = epochs, </div><div class="line">  </div><div class="line">  <span class="comment"># 验证数据</span></div><div class="line">  validation_data = valid_image_array_gen,</div><div class="line">  validation_steps = as.integer(valid_samples / batch_size),</div><div class="line">  </div><div class="line">  <span class="comment"># 打印执行进度</span></div><div class="line">  verbose = <span class="number">2</span>,</div><div class="line">  callbacks = list(</div><div class="line">    <span class="comment"># 在每一个epoch之后保存最好的模型</span></div><div class="line">    callback_model_checkpoint(<span class="string">"C:/Users/Administrator/Desktop/fruits-360/keras/fruits_checkpoints.h5"</span>, save_best_only = <span class="literal">TRUE</span>),</div><div class="line">    <span class="comment"># 在TensorBoard中可视化需要</span></div><div class="line">    callback_tensorboard(log_dir = <span class="string">"C:/Users/Administrator/Desktop/fruits-360/keras/logs"</span>)</div><div class="line">  )</div><div class="line">)</div></pre></td></tr></table></figure>
<p><img src="http://wx3.sinaimg.cn/mw690/e621a9abgy1ftnlxwrqmwj20mr0iswf9.jpg" alt="image"><br>在RStudio的视图面板中我们能看到会输出一个交互式图形。 也可以用下面的命令绘制它：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">plot(hist)</div></pre></td></tr></table></figure>
<p><img src="http://wx1.sinaimg.cn/mw690/e621a9abgy1ftnly9jrvyj20mr0isjs7.jpg" alt="image"><br>我们可以看到，此模型在验证数据集上相当准确。但是，我们需要清醒认识到我们的图片都很正规，它们都有白色的背景，水果都在图片中央，而且没有其他的东西在图片上。所以，我们的模型对看似不一样的图片将几乎不起作用（这就是为什么我们能在如此小的神经网络实现如此高准确率的原因）。</p>
<p>最后，我想看一下在TensorBoard呈现的TensorFlow图。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tensorboard(<span class="string">"C:/Users/Administrator/Desktop/fruits-360/keras/logs"</span>)</div></pre></td></tr></table></figure>
<p><img src="http://wx1.sinaimg.cn/mw690/e621a9abgy1ftnlyn8a8zj211y0hg40o.jpg" alt="image"></p>
<h2 id="疑惑"><a href="#疑惑" class="headerlink" title="疑惑"></a>疑惑</h2><p>自己的台式机（Windows 7操作系统）是主频3.4GHz的四核八线程处理器，笔记本（Deepin操作系统）是主频2.6GHz的双核四线程处理器，两者都没有使用GPU加速，结果很费解的是笔记本模型拟合时要比台式机快太多！每个epoch时间：300+ s 对比 10+ s！难道是linux比Windows要快？？？速度对比如下图所示。</p>
<ul>
<li>Windows 7</li>
</ul>
<p><img src="http://wx3.sinaimg.cn/mw690/e621a9abgy1ftnlw4c6l6j20gx0aaaal.jpg" alt="image"></p>
<ul>
<li>Deepin</li>
</ul>
<p><img src="http://wx1.sinaimg.cn/mw690/e621a9abgy1ftnlwg7fzoj20g90dfjtr.jpg" alt="image"></p>
<h1 id="添加解释"><a href="#添加解释" class="headerlink" title="添加解释"></a>添加解释</h1><p>上面做的不仅仅是怎样使用模型预测图片分类，其实单独实现预测是很无聊的，下面我将使用lime包为预测添加解释。</p>
<h2 id="加载包和模型"><a href="#加载包和模型" class="headerlink" title="加载包和模型"></a>加载包和模型</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(keras)   <span class="comment"># 调用神经网络</span></div><div class="line"><span class="keyword">library</span>(lime)    <span class="comment"># 解释解释模型</span></div><div class="line"><span class="keyword">library</span>(magick)  <span class="comment"># 预处理图片</span></div><div class="line"><span class="keyword">library</span>(ggplot2) <span class="comment"># 作图</span></div></pre></td></tr></table></figure>
<p>加载预训练好的ImageNet模型。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line">model &lt;- application_vgg16(weights = <span class="string">"imagenet"</span>, include_top = <span class="literal">TRUE</span>)</div><div class="line">model</div><div class="line"><span class="comment">## Model</span></div><div class="line">______________________________________________________________________________________________________________</div><div class="line">Layer (type)                                     Output Shape                                Param <span class="comment">#          </span></div><div class="line">==============================================================================================================</div><div class="line">input_1 (InputLayer)                             (None, <span class="number">224</span>, <span class="number">224</span>, <span class="number">3</span>)                         <span class="number">0</span>                </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">block1_conv1 (Conv2D)                            (None, <span class="number">224</span>, <span class="number">224</span>, <span class="number">64</span>)                        <span class="number">1792</span>             </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">block1_conv2 (Conv2D)                            (None, <span class="number">224</span>, <span class="number">224</span>, <span class="number">64</span>)                        <span class="number">36928</span>            </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">block1_pool (MaxPooling2D)                       (None, <span class="number">112</span>, <span class="number">112</span>, <span class="number">64</span>)                        <span class="number">0</span>                </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">block2_conv1 (Conv2D)                            (None, <span class="number">112</span>, <span class="number">112</span>, <span class="number">128</span>)                       <span class="number">73856</span>            </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">block2_conv2 (Conv2D)                            (None, <span class="number">112</span>, <span class="number">112</span>, <span class="number">128</span>)                       <span class="number">147584</span>           </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">block2_pool (MaxPooling2D)                       (None, <span class="number">56</span>, <span class="number">56</span>, <span class="number">128</span>)                         <span class="number">0</span>                </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">block3_conv1 (Conv2D)                            (None, <span class="number">56</span>, <span class="number">56</span>, <span class="number">256</span>)                         <span class="number">295168</span>           </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">block3_conv2 (Conv2D)                            (None, <span class="number">56</span>, <span class="number">56</span>, <span class="number">256</span>)                         <span class="number">590080</span>           </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">block3_conv3 (Conv2D)                            (None, <span class="number">56</span>, <span class="number">56</span>, <span class="number">256</span>)                         <span class="number">590080</span>           </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">block3_pool (MaxPooling2D)                       (None, <span class="number">28</span>, <span class="number">28</span>, <span class="number">256</span>)                         <span class="number">0</span>                </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">block4_conv1 (Conv2D)                            (None, <span class="number">28</span>, <span class="number">28</span>, <span class="number">512</span>)                         <span class="number">1180160</span>          </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">block4_conv2 (Conv2D)                            (None, <span class="number">28</span>, <span class="number">28</span>, <span class="number">512</span>)                         <span class="number">2359808</span>          </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">block4_conv3 (Conv2D)                            (None, <span class="number">28</span>, <span class="number">28</span>, <span class="number">512</span>)                         <span class="number">2359808</span>          </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">block4_pool (MaxPooling2D)                       (None, <span class="number">14</span>, <span class="number">14</span>, <span class="number">512</span>)                         <span class="number">0</span>                </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">block5_conv1 (Conv2D)                            (None, <span class="number">14</span>, <span class="number">14</span>, <span class="number">512</span>)                         <span class="number">2359808</span>          </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">block5_conv2 (Conv2D)                            (None, <span class="number">14</span>, <span class="number">14</span>, <span class="number">512</span>)                         <span class="number">2359808</span>          </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">block5_conv3 (Conv2D)                            (None, <span class="number">14</span>, <span class="number">14</span>, <span class="number">512</span>)                         <span class="number">2359808</span>          </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">block5_pool (MaxPooling2D)                       (None, <span class="number">7</span>, <span class="number">7</span>, <span class="number">512</span>)                           <span class="number">0</span>                </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">flatten (Flatten)                                (None, <span class="number">25088</span>)                               <span class="number">0</span>                </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">fc1 (Dense)                                      (None, <span class="number">4096</span>)                                <span class="number">102764544</span>        </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">fc2 (Dense)                                      (None, <span class="number">4096</span>)                                <span class="number">16781312</span>         </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">predictions (Dense)                              (None, <span class="number">1000</span>)                                <span class="number">4097000</span>          </div><div class="line">==============================================================================================================</div><div class="line">Total params: <span class="number">138</span>,<span class="number">357</span>,<span class="number">544</span></div><div class="line">Trainable params: <span class="number">138</span>,<span class="number">357</span>,<span class="number">544</span></div><div class="line">Non-trainable params: <span class="number">0</span></div><div class="line">______________________________________________________________________________________________________________</div><div class="line"><span class="comment">#加载自己的模型</span></div><div class="line">model2 &lt;- load_model_hdf5(filepath = <span class="string">"/home/feng/Downloads/fruits-360/keras/fruits_checkpoints.h5"</span>)</div><div class="line">model2</div><div class="line"><span class="comment">## Model</span></div><div class="line">______________________________________________________________________________________________________________</div><div class="line">Layer (type)                                     Output Shape                                Param <span class="comment">#          </span></div><div class="line">==============================================================================================================</div><div class="line">conv2d_1 (Conv2D)                                (None, <span class="number">20</span>, <span class="number">20</span>, <span class="number">32</span>)                          <span class="number">896</span>              </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">activation_1 (Activation)                        (None, <span class="number">20</span>, <span class="number">20</span>, <span class="number">32</span>)                          <span class="number">0</span>                </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">conv2d_2 (Conv2D)                                (None, <span class="number">20</span>, <span class="number">20</span>, <span class="number">16</span>)                          <span class="number">4624</span>             </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">leaky_re_lu_1 (LeakyReLU)                        (None, <span class="number">20</span>, <span class="number">20</span>, <span class="number">16</span>)                          <span class="number">0</span>                </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">batch_normalization_1 (BatchNormalization)       (None, <span class="number">20</span>, <span class="number">20</span>, <span class="number">16</span>)                          <span class="number">64</span>               </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">max_pooling2d_1 (MaxPooling2D)                   (None, <span class="number">10</span>, <span class="number">10</span>, <span class="number">16</span>)                          <span class="number">0</span>                </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">dropout_1 (Dropout)                              (None, <span class="number">10</span>, <span class="number">10</span>, <span class="number">16</span>)                          <span class="number">0</span>                </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">flatten_1 (Flatten)                              (None, <span class="number">1600</span>)                                <span class="number">0</span>                </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">dense_1 (Dense)                                  (None, <span class="number">100</span>)                                 <span class="number">160100</span>           </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">activation_2 (Activation)                        (None, <span class="number">100</span>)                                 <span class="number">0</span>                </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">dropout_2 (Dropout)                              (None, <span class="number">100</span>)                                 <span class="number">0</span>                </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">dense_2 (Dense)                                  (None, <span class="number">16</span>)                                  <span class="number">1616</span>             </div><div class="line">______________________________________________________________________________________________________________</div><div class="line">activation_3 (Activation)                        (None, <span class="number">16</span>)                                  <span class="number">0</span>                </div><div class="line">==============================================================================================================</div><div class="line">Total params: <span class="number">167</span>,<span class="number">300</span></div><div class="line">Trainable params: <span class="number">167</span>,<span class="number">268</span></div><div class="line">Non-trainable params: <span class="number">32</span></div><div class="line">______________________________________________________________________________________________________________</div></pre></td></tr></table></figure>
<p>加载准备图片</p>
<p>这里，我将加载并预处理两张水果图片。</p>
<ul>
<li>香蕉</li>
</ul>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">test_image_files_path &lt;- <span class="string">"C:/Users/Administrator/Desktop/fruits-360/Test"</span></div><div class="line">img &lt;- image_read(<span class="string">'https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1532608344405&amp;di=1e838eec20a80076760818110dd2e697&amp;imgtype=0&amp;src=http%3A%2F%2Fwww.lp-gj.com%2Fupload%2Fimage%2F20171206%2F20171206094968436843.jpg'</span>)</div><div class="line">img_path &lt;- file.path(test_image_files_path, <span class="string">"Banana"</span>, <span class="string">'banana.jpg'</span>)</div><div class="line">image_write(img, img_path)</div><div class="line"><span class="comment">#plot(as.raster(img))</span></div></pre></td></tr></table></figure>
<ul>
<li>橘子</li>
</ul>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">img2 &lt;- image_read(<span class="string">'https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1532615118205&amp;di=59abc0a58e9b9a724e3b82b12956a302&amp;imgtype=0&amp;src=http%3A%2F%2Fimgsrc.baidu.com%2Fimgad%2Fpic%2Fitem%2Ffc1f4134970a304ef95645d9dbc8a786c9175c99.jpg'</span>)</div><div class="line">img_path2 &lt;- file.path(test_image_files_path, <span class="string">"Clementine"</span>, <span class="string">'clementine.jpg'</span>)</div><div class="line">image_write(img2, img_path2)</div><div class="line"><span class="comment">#plot(as.raster(img2))</span></div></pre></td></tr></table></figure>
<p>Superpixels</p>
<blockquote>
<p>将图像分割成超像素是生成图像模型解释的重要一步。分割是正确的，并且在图中遵循有意义的模式，而且超级像素的大小/数量是适当的，这两者都很重要。如果图像中的重要特征被切成太多的片段，那么在几乎所有情况下，这些排列可能会破坏图像，从而导致一个糟糕的或失败的解释模型。当感兴趣的对象的大小发生变化时，不可能为超像素的数量设置硬性规则——对象相对于图像的大小越大，生成的超级像素就越少。使用plot_superpixels，在开始使用解释函数之前，可以对超像素参数进行评估。</p>
</blockquote>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">plot_superpixels(img_path, n_superpixels = <span class="number">35</span>, weight = <span class="number">10</span>)</div></pre></td></tr></table></figure>
<p><img src="http://wx2.sinaimg.cn/mw690/e621a9abgy1ftnl68velpj20dj0a7ta2.jpg" alt="image"><br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">plot_superpixels(img_path2, n_superpixels = <span class="number">50</span>, weight = <span class="number">20</span>)</div></pre></td></tr></table></figure></p>
<p><img src="http://wx2.sinaimg.cn/mw690/e621a9abgy1ftnlv8xfe9j20dj0a7jur.jpg" alt="image"><br>从超像素的图中我们可以看到，橘子的图像比香蕉图像的分辨率更高。</p>
<h2 id="为Imagenet准备图片"><a href="#为Imagenet准备图片" class="headerlink" title="为Imagenet准备图片"></a>为Imagenet准备图片</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">image_prep &lt;- <span class="keyword">function</span>(x) &#123;</div><div class="line">  arrays &lt;- lapply(x, <span class="keyword">function</span>(path) &#123;</div><div class="line">    img &lt;- image_load(path, target_size = c(<span class="number">224</span>,<span class="number">224</span>))</div><div class="line">    x &lt;- image_to_array(img)</div><div class="line">    x &lt;- array_reshape(x, c(<span class="number">1</span>, dim(x)))</div><div class="line">    x &lt;- imagenet_preprocess_input(x)</div><div class="line">  &#125;)</div><div class="line">  do.call(abind::abind, c(arrays, list(along = <span class="number">1</span>)))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>测试预测结果</li>
</ul>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">res &lt;- predict(model, image_prep(c(img_path, img_path2)))</div><div class="line">imagenet_decode_predictions(res)</div><div class="line">[[<span class="number">1</span>]]</div><div class="line">  class_name class_description       score</div><div class="line"><span class="number">1</span>  n07753592            banana <span class="number">0.937849104</span></div><div class="line"><span class="number">2</span>  n03786901            mortar <span class="number">0.014285510</span></div><div class="line"><span class="number">3</span>  n03532672              hook <span class="number">0.007741872</span></div><div class="line"><span class="number">4</span>  n04579432           whistle <span class="number">0.004215840</span></div><div class="line"><span class="number">5</span>  n07747607            orange <span class="number">0.002990912</span></div><div class="line"></div><div class="line">[[<span class="number">2</span>]]</div><div class="line">  class_name class_description      score</div><div class="line"><span class="number">1</span>  n07747607            orange <span class="number">0.65372097</span></div><div class="line"><span class="number">2</span>  n07749582             lemon <span class="number">0.07017834</span></div><div class="line"><span class="number">3</span>  n07717556  butternut_squash <span class="number">0.05920389</span></div><div class="line"><span class="number">4</span>  n07720875       bell_pepper <span class="number">0.03030883</span></div><div class="line"><span class="number">5</span>  n03937543       pill_bottle <span class="number">0.02684177</span></div></pre></td></tr></table></figure>
<ul>
<li>加载标签和训练解释</li>
</ul>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">model_labels &lt;- readRDS(system.file(<span class="string">'extdata'</span>, <span class="string">'imagenet_labels.rds'</span>, package = <span class="string">'lime'</span>))</div><div class="line">explainer &lt;- lime(c(img_path, img_path2), as_classifier(model, model_labels), image_prep)</div></pre></td></tr></table></figure>
<p>训练这个解释器需要相当长的时间，我自己模型中的较小图片比较大规模的Imagenet训练的时间要快很多。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">explanation &lt;- explain(c(img_path, img_path2), explainer, </div><div class="line">                       n_labels = <span class="number">2</span>, n_features = <span class="number">35</span>,</div><div class="line">                       n_superpixels = <span class="number">35</span>, weight = <span class="number">10</span>,</div><div class="line">                       background = <span class="string">"white"</span>)</div></pre></td></tr></table></figure>
<ul>
<li>plot_image_explanation()函数一次只支持一个实例</li>
</ul>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">plot_image_explanation(explanation)</div></pre></td></tr></table></figure>
<p><img src="http://wx4.sinaimg.cn/mw690/e621a9abgy1ftnlusl76oj20dj0a7jse.jpg" alt="image"><br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">clementine &lt;- explanation[explanation$case == <span class="string">"clementine.jpg"</span>,]</div><div class="line">plot_image_explanation(clementine)</div></pre></td></tr></table></figure></p>
<p><img src="http://wx4.sinaimg.cn/mw690/e621a9abgy1ftnlvplzn1j20dj0a7t9y.jpg" alt="image"></p>
<h2 id="为我自己的模型准备图片"><a href="#为我自己的模型准备图片" class="headerlink" title="为我自己的模型准备图片"></a>为我自己的模型准备图片</h2><p>测试预测结果(类似于训练和验证图片)</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">test_datagen &lt;- image_data_generator(rescale = <span class="number">1</span>/<span class="number">255</span>)</div><div class="line"></div><div class="line">test_generator &lt;- flow_images_from_directory(</div><div class="line">        test_image_files_path,</div><div class="line">        test_datagen,</div><div class="line">        target_size = c(<span class="number">20</span>, <span class="number">20</span>),</div><div class="line">        class_mode = <span class="string">'categorical'</span>)</div><div class="line"></div><div class="line">predictions &lt;- as.data.frame(predict_generator(model2, test_generator, steps = <span class="number">1</span>))</div><div class="line"></div><div class="line">load(<span class="string">"/Users/shiringlander/Documents/Github/DL_AI/Tutti_Frutti/fruits-360/fruits_classes_indices.RData"</span>)</div><div class="line">fruits_classes_indices_df &lt;- data.frame(indices = unlist(fruits_classes_indices))</div><div class="line">fruits_classes_indices_df &lt;- fruits_classes_indices_df[order(fruits_classes_indices_df$indices), , drop = <span class="literal">FALSE</span>]</div><div class="line">colnames(predictions) &lt;- rownames(fruits_classes_indices_df)</div><div class="line"></div><div class="line">t(round(predictions, digits = <span class="number">2</span>))</div><div class="line">            [,<span class="number">1</span>] [,<span class="number">2</span>]</div><div class="line">Kiwi        <span class="number">0.00</span>    <span class="number">0</span></div><div class="line">Banana      <span class="number">0.06</span>    <span class="number">1</span></div><div class="line">Apricot     <span class="number">0.02</span>    <span class="number">0</span></div><div class="line">Avocado     <span class="number">0.00</span>    <span class="number">0</span></div><div class="line">Cocos       <span class="number">0.00</span>    <span class="number">0</span></div><div class="line">Clementine  <span class="number">0.86</span>    <span class="number">0</span></div><div class="line">Mandarine   <span class="number">0.03</span>    <span class="number">0</span></div><div class="line">Orange      <span class="number">0.00</span>    <span class="number">0</span></div><div class="line">Limes       <span class="number">0.00</span>    <span class="number">0</span></div><div class="line">Lemon       <span class="number">0.02</span>    <span class="number">0</span></div><div class="line">Peach       <span class="number">0.00</span>    <span class="number">0</span></div><div class="line">Plum        <span class="number">0.00</span>    <span class="number">0</span></div><div class="line">Raspberry   <span class="number">0.00</span>    <span class="number">0</span></div><div class="line">Strawberry  <span class="number">0.01</span>    <span class="number">0</span></div><div class="line">Pineapple   <span class="number">0.00</span>    <span class="number">0</span></div><div class="line">Pomegranate <span class="number">0.00</span>    <span class="number">0</span></div><div class="line"><span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span>:nrow(predictions)) &#123;</div><div class="line">  cat(i, <span class="string">":"</span>)</div><div class="line">  print(unlist(which.max(predictions[i, ])))</div><div class="line">&#125;</div><div class="line"><span class="number">1</span> :Clementine </div><div class="line">         <span class="number">6</span> </div><div class="line"><span class="number">2</span> :Banana </div><div class="line">     <span class="number">2</span></div></pre></td></tr></table></figure>
<p>尽管这似乎和lime不太符合,所以我准备了类似于Imagenet的图片。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">image_prep2 &lt;- <span class="keyword">function</span>(x) &#123;</div><div class="line">  arrays &lt;- lapply(x, <span class="keyword">function</span>(path) &#123;</div><div class="line">    img &lt;- image_load(path, target_size = c(<span class="number">20</span>, <span class="number">20</span>))</div><div class="line">    x &lt;- image_to_array(img)</div><div class="line">    x &lt;- reticulate::array_reshape(x, c(<span class="number">1</span>, dim(x)))</div><div class="line">    x &lt;- x / <span class="number">255</span></div><div class="line">  &#125;)</div><div class="line">  do.call(abind::abind, c(arrays, list(along = <span class="number">1</span>)))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>准备标签</li>
</ul>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">fruits_classes_indices_l &lt;- rownames(fruits_classes_indices_df)</div><div class="line">names(fruits_classes_indices_l) &lt;- unlist(fruits_classes_indices)</div><div class="line">fruits_classes_indices_l</div><div class="line">            <span class="number">0</span>             <span class="number">1</span>             <span class="number">2</span>             <span class="number">3</span>             <span class="number">4</span>             <span class="number">5</span> </div><div class="line">       <span class="string">"Kiwi"</span>      <span class="string">"Banana"</span>     <span class="string">"Apricot"</span>     <span class="string">"Avocado"</span>       <span class="string">"Cocos"</span>  <span class="string">"Clementine"</span> </div><div class="line">            <span class="number">6</span>             <span class="number">7</span>             <span class="number">8</span>             <span class="number">9</span>            <span class="number">10</span>            <span class="number">11</span> </div><div class="line">  <span class="string">"Mandarine"</span>      <span class="string">"Orange"</span>       <span class="string">"Limes"</span>       <span class="string">"Lemon"</span>       <span class="string">"Peach"</span>        <span class="string">"Plum"</span> </div><div class="line">           <span class="number">12</span>            <span class="number">13</span>            <span class="number">14</span>            <span class="number">15</span> </div><div class="line">  <span class="string">"Raspberry"</span>  <span class="string">"Strawberry"</span>   <span class="string">"Pineapple"</span> <span class="string">"Pomegranate"</span></div></pre></td></tr></table></figure>
<ul>
<li>训练解释器</li>
</ul>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">explainer2 &lt;- lime(c(img_path, img_path2), as_classifier(model2, fruits_classes_indices_l), image_prep2)</div><div class="line">explanation2 &lt;- explain(c(img_path, img_path2), explainer2, </div><div class="line">                        n_labels = <span class="number">1</span>, n_features = <span class="number">20</span>,</div><div class="line">                        n_superpixels = <span class="number">35</span>, weight = <span class="number">10</span>,</div><div class="line">                        background = <span class="string">"white"</span>)</div></pre></td></tr></table></figure>
<ul>
<li>绘制特征权重图以寻找绘图的最佳的块阀值 (见下图)</li>
</ul>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">explanation2 %&gt;%</div><div class="line">  ggplot(aes(x = feature_weight)) +</div><div class="line">    facet_wrap(~ case, scales = <span class="string">"free"</span>) +</div><div class="line">    geom_density()</div></pre></td></tr></table></figure>
<p><img src="http://wx2.sinaimg.cn/mw690/e621a9abgy1ftnl5ntfnej20dj0a7mx1.jpg" alt="image"></p>
<ul>
<li>绘制预测</li>
</ul>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">plot_image_explanation(explanation2, display = <span class="string">'block'</span>, threshold = <span class="number">1e-09</span>)</div></pre></td></tr></table></figure>
<p><img src="http://wx2.sinaimg.cn/mw690/e621a9abgy1ftnl5sf0yvj20dj0a7wep.jpg" alt="image"><br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">clementine2 &lt;- explanation2[explanation2$case == <span class="string">"clementine.jpg"</span>,]</div><div class="line">plot_image_explanation(clementine2, display = <span class="string">'block'</span>, threshold = <span class="number">0.01</span>)</div></pre></td></tr></table></figure></p>
<p><img src="http://wx4.sinaimg.cn/mw690/e621a9abgy1ftnl5w5tn4j20dj0a7abp.jpg" alt="image"><br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">sessionInfo()</div><div class="line">R version <span class="number">3.5</span><span class="number">.0</span> (<span class="number">2018</span>-<span class="number">04</span>-<span class="number">23</span>)</div><div class="line">Platform: x86_64-w64-mingw32/x64 (<span class="number">64</span>-bit)</div><div class="line">Running under: Windows <span class="number">7</span> x64 (build <span class="number">7601</span>) Service Pack <span class="number">1</span></div><div class="line"></div><div class="line">Matrix products: default</div><div class="line"></div><div class="line">locale:</div><div class="line">[<span class="number">1</span>] LC_COLLATE=Chinese (Simplified)_People<span class="string">'s Republic of China.936 </span></div><div class="line">[2] LC_CTYPE=Chinese (Simplified)_People's Republic of China.936   </div><div class="line">[<span class="number">3</span>] LC_MONETARY=Chinese (Simplified)_People<span class="string">'s Republic of China.936</span></div><div class="line">[4] LC_NUMERIC=C                                                   </div><div class="line">[5] LC_TIME=Chinese (Simplified)_People's Republic of China.936    </div><div class="line"></div><div class="line">attached base packages:</div><div class="line">[<span class="number">1</span>] stats     graphics  grDevices utils     datasets  methods   base     </div><div class="line"></div><div class="line">other attached packages:</div><div class="line">[<span class="number">1</span>] ggplot2_2.2.1 magick_1.9    lime_0.4.0    keras_2.1.6  </div><div class="line"></div><div class="line">loaded via a namespace (and not attached):</div><div class="line"> [<span class="number">1</span>] Rcpp_0.12.16       pillar_1.2.2       compiler_3.5.0     later_0.7.3       </div><div class="line"> [<span class="number">5</span>] gower_0.1.2        plyr_1.8.4         base64enc_0.1-<span class="number">3</span>    iterators_1.0.9   </div><div class="line"> [<span class="number">9</span>] tools_3.5.0        zeallot_0.1.0      digest_0.6.15      jsonlite_1.5      </div><div class="line">[<span class="number">13</span>] tibble_1.4.2       gtable_0.2.0       lattice_0.20-<span class="number">35</span>    rlang_0.2.0       </div><div class="line">[<span class="number">17</span>] Matrix_1.2-<span class="number">14</span>      foreach_1.4.4      shiny_1.1.0        curl_3.2          </div><div class="line">[<span class="number">21</span>] parallel_3.5.0     knitr_1.20         htmlwidgets_1.2    grid_3.5.0        </div><div class="line">[<span class="number">25</span>] glmnet_2.0-<span class="number">16</span>      reticulate_1.9     R6_2.2.2           magrittr_1.5      </div><div class="line">[<span class="number">29</span>] whisker_0.3-<span class="number">2</span>      shinythemes_1.1.1  promises_1.0.1     scales_0.5.0      </div><div class="line">[<span class="number">33</span>] codetools_0.2-<span class="number">15</span>   tfruns_1.3         htmltools_0.3.6    abind_1.4-<span class="number">5</span>       </div><div class="line">[<span class="number">37</span>] stringdist_0.9.4.7 assertthat_0.2.0   xtable_1.8-<span class="number">2</span>       mime_0.5          </div><div class="line">[<span class="number">41</span>] colorspace_1.3-<span class="number">2</span>   httpuv_1.4.5       labeling_0.3       tensorflow_1.8    </div><div class="line">[<span class="number">45</span>] stringi_1.1.7      lazyeval_0.2.1     munsell_0.4.3</div></pre></td></tr></table></figure></p>
</div><div class="tags"><a href="/tags/keras/">keras</a><a href="/tags/图像分类/">图像分类</a><a href="/tags/lime/">lime</a><a href="/tags/tensorflow/">tensorflow</a></div><div class="post-share"><div class="jiathis_style"><span class="jiathis_txt">分享到：</span><a class="jiathis_button_tsina"></a><a class="jiathis_button_qzone"></a><a class="jiathis_button_weixin"></a><a class="jiathis_button_fb"></a><a class="jiathis_button_linkedin"></a><a class="jiathis_button_twitter"></a><a class="jiathis_button_ydnote"></a><a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis"></a><a class="jiathis_counter_style"></a></div></div><div class="post-nav"><a href="/2018/08/22/使用rvest抓取NBA历史比赛数据/" class="next">使用rvest抓取NBA历史比赛数据</a></div><div id="comments"><div id="uyan_frame"></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#为不同类型的水果建立图像分类器"><span class="toc-text">为不同类型的水果建立图像分类器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#代码开始"><span class="toc-text">代码开始</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#加载图片"><span class="toc-text">加载图片</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#现在将图片载入内存并调增大小"><span class="toc-text">现在将图片载入内存并调增大小</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#定义模型"><span class="toc-text">定义模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#拟合模型"><span class="toc-text">拟合模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#疑惑"><span class="toc-text">疑惑</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#添加解释"><span class="toc-text">添加解释</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#加载包和模型"><span class="toc-text">加载包和模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#为Imagenet准备图片"><span class="toc-text">为Imagenet准备图片</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#为我自己的模型准备图片"><span class="toc-text">为我自己的模型准备图片</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/08/22/R使用keras包和lime包实现图像分类并添加解释/">R使用keras包和lime包实现图像分类并添加解释</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/22/使用rvest抓取NBA历史比赛数据/">使用rvest抓取NBA历史比赛数据</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/22/R机器学习之股票预测初探/">R机器学习之股票预测初探</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/22/R中如何对量化策略进行回测/">R中如何对量化策略进行回测</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/22/data.table() vs data.frame() – R大数据集处理/">data.table() vs data.frame() – R大数据集处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/22/R中的大数据分析/">R中的大数据分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/22/使用H2O和data.table构建R大数据集模型/">使用H2O和data.table构建R大数据集模型</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/22/侦测欺诈交易/">侦测欺诈交易</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/22/实战Caret包对借贷数据进行机器学习预测/">实战Caret包对借贷数据进行机器学习预测</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/22/购物篮关联规则分析/">购物篮关联规则分析</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Python-R/">Python + R</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/R/">R</a><span class="category-list-count">10</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/离群值侦测排序/" style="font-size: 15px;">离群值侦测排序</a> <a href="/tags/量化金融/" style="font-size: 15px;">量化金融</a> <a href="/tags/大数据/" style="font-size: 15px;">大数据</a> <a href="/tags/聚类/" style="font-size: 15px;">聚类</a> <a href="/tags/线性回归/" style="font-size: 15px;">线性回归</a> <a href="/tags/股票预测/" style="font-size: 15px;">股票预测</a> <a href="/tags/机器学习/" style="font-size: 15px;">机器学习</a> <a href="/tags/特征选取/" style="font-size: 15px;">特征选取</a> <a href="/tags/keras/" style="font-size: 15px;">keras</a> <a href="/tags/图像分类/" style="font-size: 15px;">图像分类</a> <a href="/tags/lime/" style="font-size: 15px;">lime</a> <a href="/tags/tensorflow/" style="font-size: 15px;">tensorflow</a> <a href="/tags/网络爬虫/" style="font-size: 15px;">网络爬虫</a> <a href="/tags/H2O/" style="font-size: 15px;">H2O</a> <a href="/tags/欺诈侦测/" style="font-size: 15px;">欺诈侦测</a> <a href="/tags/半监督分类/" style="font-size: 15px;">半监督分类</a> <a href="/tags/类失衡/" style="font-size: 15px;">类失衡</a> <a href="/tags/贝叶斯分类器/" style="font-size: 15px;">贝叶斯分类器</a> <a href="/tags/AdaBoost分类器/" style="font-size: 15px;">AdaBoost分类器</a> <a href="/tags/决策精确度/" style="font-size: 15px;">决策精确度</a> <a href="/tags/回溯精确度/" style="font-size: 15px;">回溯精确度</a> <a href="/tags/交叉验证/" style="font-size: 15px;">交叉验证</a> <a href="/tags/回测/" style="font-size: 15px;">回测</a> <a href="/tags/Caret预测/" style="font-size: 15px;">Caret预测</a> <a href="/tags/数据预处理/" style="font-size: 15px;">数据预处理</a> <a href="/tags/数据分割/" style="font-size: 15px;">数据分割</a> <a href="/tags/特征选择/" style="font-size: 15px;">特征选择</a> <a href="/tags/参数调优/" style="font-size: 15px;">参数调优</a> <a href="/tags/变量重要性评估/" style="font-size: 15px;">变量重要性评估</a> <a href="/tags/购物篮/" style="font-size: 15px;">购物篮</a> <a href="/tags/关联规则/" style="font-size: 15px;">关联规则</a> <a href="/tags/推荐算法/" style="font-size: 15px;">推荐算法</a> <a href="/tags/逻辑回归/" style="font-size: 15px;">逻辑回归</a> <a href="/tags/决策树/" style="font-size: 15px;">决策树</a> <a href="/tags/支持向量机/" style="font-size: 15px;">支持向量机</a> <a href="/tags/朴素贝叶斯/" style="font-size: 15px;">朴素贝叶斯</a> <a href="/tags/最近邻（KNN）/" style="font-size: 15px;">最近邻（KNN）</a> <a href="/tags/K-均值/" style="font-size: 15px;">K-均值</a> <a href="/tags/随机森林/" style="font-size: 15px;">随机森林</a> <a href="/tags/降维算法/" style="font-size: 15px;">降维算法</a> <a href="/tags/梯度下降算法/" style="font-size: 15px;">梯度下降算法</a> <a href="/tags/GBM/" style="font-size: 15px;">GBM</a> <a href="/tags/XGBoost/" style="font-size: 15px;">XGBoost</a> <a href="/tags/LightGBM/" style="font-size: 15px;">LightGBM</a> <a href="/tags/CatBoost/" style="font-size: 15px;">CatBoost</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="http://weibo.com/youthcolor" title="Geekdreams" target="_blank">Geekdreams</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">youthcolor.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>var jiathis_config={
    data_track_clickback:true,
    summary:"",
    shortUrl:true,
    hideMore:false
}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script><script src="http://v2.uyan.cc/code/uyan.js?uid=2136627"></script></body></html>