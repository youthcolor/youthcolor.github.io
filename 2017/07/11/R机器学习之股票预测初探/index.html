<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="youthcolor's blog"><title>R机器学习之股票预测初探 | Geekdreams</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">R机器学习之股票预测初探</h1><a id="logo" href="/.">Geekdreams</a><p class="description">Nothing is difficult to the man who will try.</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">R机器学习之股票预测初探</h1><div class="post-meta"><a href="/2017/07/11/R机器学习之股票预测初探/#comments" class="comment-count"><a id="uyan_count_unit" href="/2017/07/11/R机器学习之股票预测初探/"></a>留言</a><p><span class="date">Jul 11, 2017</span><span><a href="/categories/R/" class="category">R</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p>如今机器学习在工业界和学术界都愈发火热，智能化的崭新时代正在向我们走来。在金融领域，是否也能应用机器学习的方法做股票涨跌的预测呢？下面就以R语言的相关机器学习包为例，简单做股票预测方面的初探。</p>
<a id="more"></a>
<h2 id="数据准备"><a href="#数据准备" class="headerlink" title="数据准备"></a>数据准备</h2><p>昨天，我已经从同花顺中导出了“<em>分众传媒</em>”（股票代码：<em>002027</em>）的历史交易数据，该数据集包含了“时间,开盘,最高,最低,收盘,涨幅,振幅,总手,金额,换手%,成交次数”等维度的数据。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 载入包</span></div><div class="line"><span class="keyword">library</span>(quantmod);<span class="keyword">library</span>(TTR);<span class="keyword">library</span>(randomForest); </div><div class="line"><span class="keyword">library</span>(caret);<span class="keyword">library</span>(corrplot);<span class="keyword">library</span>(pROC);<span class="keyword">library</span>(FSelector)</div><div class="line">XYZQ &lt;- read.csv(<span class="string">"002027.csv"</span>, header = <span class="literal">T</span>, stringsAsFactors = <span class="literal">F</span>)</div><div class="line">names(XYZQ) &lt;- c(<span class="string">"Index"</span>, <span class="string">"Open"</span>, <span class="string">"High"</span>, <span class="string">"Low"</span>, <span class="string">"Close"</span>, <span class="string">"zhangfu"</span>, <span class="string">"zhenfu"</span>, </div><div class="line">                 <span class="string">"Volume"</span>, <span class="string">"jine"</span>, <span class="string">"huanshou"</span>, <span class="string">"chengjiaocishu"</span>)</div><div class="line">XYZQ &lt;- XYZQ[XYZQ$Volume != <span class="number">0</span>, ]</div><div class="line">tail(XYZQ)</div><div class="line">             Index   Open   High    Low  Close zhangfu zhenfu      Volume</div><div class="line"><span class="number">2979</span> <span class="number">2017</span>-<span class="number">06</span>-<span class="number">15</span>,四 <span class="number">102.94</span> <span class="number">104.48</span> <span class="number">101.04</span> <span class="number">101.53</span>  -<span class="number">1.77</span>%  <span class="number">3.33</span>%  <span class="number">34</span>,<span class="number">873</span>,<span class="number">418</span></div><div class="line"><span class="number">2980</span> <span class="number">2017</span>-<span class="number">06</span>-<span class="number">16</span>,五 <span class="number">101.53</span> <span class="number">103.15</span> <span class="number">100.27</span> <span class="number">102.73</span>   <span class="number">1.18</span>%  <span class="number">2.83</span>%  <span class="number">31</span>,<span class="number">332</span>,<span class="number">336</span></div><div class="line"><span class="number">2981</span> <span class="number">2017</span>-<span class="number">06</span>-<span class="number">19</span>,一  <span class="number">92.55</span>  <span class="number">97.11</span>  <span class="number">92.55</span>  <span class="number">92.76</span>  -<span class="number">9.71</span>%  <span class="number">4.44</span>% <span class="number">162</span>,<span class="number">266</span>,<span class="number">250</span></div><div class="line"><span class="number">2982</span> <span class="number">2017</span>-<span class="number">06</span>-<span class="number">20</span>,二  <span class="number">93.11</span>  <span class="number">95.57</span>  <span class="number">93.11</span>  <span class="number">94.23</span>   <span class="number">1.58</span>%  <span class="number">2.65</span>%  <span class="number">44</span>,<span class="number">149</span>,<span class="number">718</span></div><div class="line"><span class="number">2983</span> <span class="number">2017</span>-<span class="number">06</span>-<span class="number">21</span>,三  <span class="number">94.30</span>  <span class="number">96.41</span>  <span class="number">91.71</span>  <span class="number">94.58</span>   <span class="number">0.37</span>%  <span class="number">4.99</span>%  <span class="number">41</span>,<span class="number">641</span>,<span class="number">757</span></div><div class="line"><span class="number">2984</span> <span class="number">2017</span>-<span class="number">06</span>-<span class="number">22</span>,四  <span class="number">94.09</span>  <span class="number">97.95</span>  <span class="number">93.88</span>  <span class="number">96.48</span>   <span class="number">2.01</span>%  <span class="number">4.30</span>%  <span class="number">23</span>,<span class="number">065</span>,<span class="number">242</span></div><div class="line">              jine huanshou chengjiaocishu</div><div class="line"><span class="number">2979</span>   <span class="number">503</span>,<span class="number">424</span>,<span class="number">470</span>    <span class="number">0.861</span>          <span class="number">23056</span></div><div class="line"><span class="number">2980</span>   <span class="number">448</span>,<span class="number">854</span>,<span class="number">630</span>    <span class="number">0.774</span>          <span class="number">21137</span></div><div class="line"><span class="number">2981</span> <span class="number">2</span>,<span class="number">141</span>,<span class="number">561</span>,<span class="number">400</span>    <span class="number">4.010</span>          <span class="number">58142</span></div><div class="line"><span class="number">2982</span>   <span class="number">586</span>,<span class="number">119</span>,<span class="number">870</span>    <span class="number">1.090</span>          <span class="number">26975</span></div><div class="line"><span class="number">2983</span>   <span class="number">550</span>,<span class="number">581</span>,<span class="number">210</span>    <span class="number">1.030</span>          <span class="number">24989</span></div><div class="line"><span class="number">2984</span>   <span class="number">313</span>,<span class="number">326</span>,<span class="number">010</span>    <span class="number">0.570</span>          <span class="number">13919</span></div></pre></td></tr></table></figure>
<h2 id="数据预处理"><a href="#数据预处理" class="headerlink" title="数据预处理"></a>数据预处理</h2><p>下面需要对导出的数据进行处理，使他符合自己期望的格式要求。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span>(i <span class="keyword">in</span> <span class="number">1</span>:nrow(XYZQ))&#123;</div><div class="line">  <span class="comment"># XYZQ[i,"week"] &lt;-  strsplit(as.character(XYZQ[i,"Index"]), split = ",")[[1]][2]</span></div><div class="line">  <span class="comment"># 提取日期</span></div><div class="line">  XYZQ[i,<span class="number">1</span>] &lt;-  strsplit(as.character(XYZQ[i,<span class="number">1</span>]), split = <span class="string">","</span>)[[<span class="number">1</span>]][<span class="number">1</span>]</div><div class="line">  <span class="comment"># 去除%号</span></div><div class="line">  XYZQ[i,<span class="string">"zhangfu"</span>] &lt;-  strsplit(as.character(XYZQ[i,<span class="string">"zhangfu"</span>]), split = <span class="string">"%"</span>)[[<span class="number">1</span>]][<span class="number">1</span>]</div><div class="line">  XYZQ[i,<span class="string">"zhenfu"</span>] &lt;-  strsplit(as.character(XYZQ[i,<span class="string">"zhenfu"</span>]), split = <span class="string">"%"</span>)[[<span class="number">1</span>]][<span class="number">1</span>]</div><div class="line">&#125;</div><div class="line"><span class="comment"># 类型转换</span></div><div class="line">XYZQ[,<span class="number">1</span>] &lt;- as.Date(XYZQ[,<span class="number">1</span>])</div><div class="line"><span class="comment"># XYZQ$week &lt;- as.factor(XYZQ$week)</span></div><div class="line">XYZQ$zhangfu &lt;- as.numeric(XYZQ$zhangfu)</div><div class="line">XYZQ$zhenfu &lt;- as.numeric(XYZQ$zhenfu)</div><div class="line">XYZQ$Volume &lt;- as.numeric(gsub(<span class="string">","</span>,<span class="string">""</span>, XYZQ$Volume))</div><div class="line">XYZQ$jine &lt;- as.numeric(gsub(<span class="string">","</span>,<span class="string">""</span>, XYZQ$jine))</div><div class="line"><span class="comment"># 时间序列xts类型转换</span></div><div class="line">XYZQ &lt;- xts(XYZQ[,-<span class="number">1</span>], order.by = XYZQ[, <span class="number">1</span>])</div></pre></td></tr></table></figure></p>
<h2 id="特征提取"><a href="#特征提取" class="headerlink" title="特征提取"></a>特征提取</h2><p>在R中提供了许多金融指标的<em>TTR</em>包，使用它可以很方便的提取出各种金融指标。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 换手率</span></div><div class="line">huanshou &lt;- XYZQ$huanshou</div><div class="line">huanshou &lt;- as.data.frame(huanshou)$huanshou</div><div class="line">huanshou &lt;- c(<span class="literal">NA</span>, huanshou)</div><div class="line"><span class="comment"># 振幅</span></div><div class="line">zhenfu &lt;- XYZQ$zhenfu</div><div class="line">zhenfu &lt;- as.data.frame(zhenfu)$zhenfu</div><div class="line">zhenfu &lt;- c(<span class="literal">NA</span>, zhenfu)</div><div class="line"><span class="comment"># 第二日涨跌信号</span></div><div class="line">Close &lt;- ifelse(XYZQ$zhangfu &gt; <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>)</div><div class="line">Close &lt;- as.data.frame(Close)$zhangfu</div><div class="line">Close &lt;- c(Close,<span class="literal">NA</span>)</div><div class="line"><span class="comment"># TTR指标</span></div><div class="line">myATR &lt;- ATR(HLC(XYZQ))[,<span class="string">'atr'</span>] ; myATR &lt;- c(<span class="literal">NA</span>,myATR) ;</div><div class="line">mySMI &lt;- SMI(HLC(XYZQ))[,<span class="string">'SMI'</span>] ; mySMI &lt;- c(<span class="literal">NA</span>,mySMI) ;</div><div class="line">myADX &lt;- ADX(HLC(XYZQ))[,<span class="string">'ADX'</span>] ; myADX &lt;- c(<span class="literal">NA</span>,myADX) ;</div><div class="line">myAroon &lt;- aroon(XYZQ[,c(<span class="string">'High'</span>,<span class="string">'Low'</span>)])$oscillator ; myAroon &lt;- c(<span class="literal">NA</span>,myAroon) ;</div><div class="line">myBB &lt;- BBands(HLC(XYZQ))[,<span class="string">'pctB'</span>] ; myBB &lt;- c(<span class="literal">NA</span>,myBB) ;</div><div class="line">myChaikinVol &lt;- Delt(chaikinVolatility(XYZQ[,c(<span class="string">"High"</span>,<span class="string">"Low"</span>)]))[,<span class="number">1</span>] ; myChaikinVol &lt;- c(<span class="literal">NA</span>,myChaikinVol) ;</div><div class="line">myCLV &lt;- EMA(CLV(HLC(XYZQ)))[,<span class="number">1</span>] ; myCLV &lt;- c(<span class="literal">NA</span>,myCLV) ;</div><div class="line">myEMV &lt;- EMV(XYZQ[,c(<span class="string">'High'</span>,<span class="string">'Low'</span>)],XYZQ[,<span class="string">'Volume'</span>])[,<span class="number">2</span>] ; myEMV &lt;- c(<span class="literal">NA</span>,myEMV) ;</div><div class="line">myMACD &lt;- MACD(Cl(XYZQ))[,<span class="number">2</span>] ; myMACD &lt;- c(<span class="literal">NA</span>,myMACD) ;</div><div class="line">myMFI &lt;- MFI(XYZQ[,c(<span class="string">"High"</span>,<span class="string">"Low"</span>,<span class="string">"Close"</span>)], XYZQ[,<span class="string">"Volume"</span>]) ; myMFI &lt;- c(<span class="literal">NA</span>,myMFI) ;</div><div class="line">mySAR &lt;- SAR(XYZQ[,c(<span class="string">'High'</span>,<span class="string">'Close'</span>)]) [,<span class="number">1</span>] ; mySAR &lt;- c(<span class="literal">NA</span>,mySAR) ;</div><div class="line">myVolat &lt;- volatility(OHLC(XYZQ),calc=<span class="string">"garman"</span>)[,<span class="number">1</span>] ; myVolat &lt;- c(<span class="literal">NA</span>,myVolat) ;</div><div class="line">myCMO &lt;- CMO(Cl(XYZQ)) ; myCMO &lt;- c(<span class="literal">NA</span>,myCMO) ;</div><div class="line">myEMA &lt;- EMA(Delt(Cl(XYZQ))) ; myEMA &lt;- c(<span class="literal">NA</span>,myEMA) ;</div><div class="line">forceindex &lt;- (XYZQ$Close - XYZQ$Open) * XYZQ$Volume ; forceindex &lt;- c(<span class="literal">NA</span>,forceindex) ;</div><div class="line">WillR5  &lt;- WPR(XYZQ[,c(<span class="string">"High"</span>,<span class="string">"Low"</span>,<span class="string">"Close"</span>)], n = <span class="number">5</span>) ; WillR5 &lt;- c(<span class="literal">NA</span>,WillR5) ;</div><div class="line">WillR10 &lt;- WPR(XYZQ[,c(<span class="string">"High"</span>,<span class="string">"Low"</span>,<span class="string">"Close"</span>)], n = <span class="number">10</span>) ; WillR10 &lt;- c(<span class="literal">NA</span>,WillR10) ;</div><div class="line">WillR15 &lt;- WPR(XYZQ[,c(<span class="string">"High"</span>,<span class="string">"Low"</span>,<span class="string">"Close"</span>)], n = <span class="number">15</span>) ; WillR15 &lt;- c(<span class="literal">NA</span>,WillR15) ;</div><div class="line">WillR30  &lt;- WPR(XYZQ[,c(<span class="string">"High"</span>,<span class="string">"Low"</span>,<span class="string">"Close"</span>)], n = <span class="number">30</span>) ; WillR30 &lt;- c(<span class="literal">NA</span>,WillR30) ;</div><div class="line">WillR45 &lt;- WPR(XYZQ[,c(<span class="string">"High"</span>,<span class="string">"Low"</span>,<span class="string">"Close"</span>)], n = <span class="number">45</span>) ; WillR45 &lt;- c(<span class="literal">NA</span>,WillR45) ;</div><div class="line">WillR60 &lt;- WPR(XYZQ[,c(<span class="string">"High"</span>,<span class="string">"Low"</span>,<span class="string">"Close"</span>)], n = <span class="number">60</span>) ; WillR60 &lt;- c(<span class="literal">NA</span>,WillR60) ;</div><div class="line">RSI5  &lt;- RSI(XYZQ$Close, n = <span class="number">5</span>,maType=<span class="string">"WMA"</span>) ;RSI5 &lt;- c(<span class="literal">NA</span>,RSI5) ;</div><div class="line">RSI10 &lt;- RSI(XYZQ$Close, n = <span class="number">10</span>,maType=<span class="string">"WMA"</span>) ;RSI10 &lt;- c(<span class="literal">NA</span>,RSI10) ;</div><div class="line">RSI15 &lt;- RSI(XYZQ$Close, n = <span class="number">15</span>,maType=<span class="string">"WMA"</span>) ;RSI15 &lt;- c(<span class="literal">NA</span>,RSI15) ;</div><div class="line">RSI30  &lt;- RSI(XYZQ$Close, n = <span class="number">30</span>,maType=<span class="string">"WMA"</span>) ;RSI30 &lt;- c(<span class="literal">NA</span>,RSI30) ;</div><div class="line">RSI45 &lt;- RSI(XYZQ$Close, n = <span class="number">45</span>,maType=<span class="string">"WMA"</span>) ;RSI45 &lt;- c(<span class="literal">NA</span>,RSI45) ;</div><div class="line">RSI60 &lt;- RSI(XYZQ$Close, n = <span class="number">60</span>,maType=<span class="string">"WMA"</span>) ;RSI60 &lt;- c(<span class="literal">NA</span>,RSI60) ;</div><div class="line">ROC5 &lt;- ROC(XYZQ$Close, n = <span class="number">5</span>,type =<span class="string">"discrete"</span>)*<span class="number">100</span> ; ROC5 &lt;- c(<span class="literal">NA</span>,ROC5) ;</div><div class="line">ROC10 &lt;- ROC(XYZQ$Close, n = <span class="number">10</span>,type =<span class="string">"discrete"</span>)*<span class="number">100</span> ; ROC10 &lt;- c(<span class="literal">NA</span>,ROC10) ;</div><div class="line">ROC15 &lt;- ROC(XYZQ$Close, n = <span class="number">15</span>,type =<span class="string">"discrete"</span>)*<span class="number">100</span> ; ROC15 &lt;- c(<span class="literal">NA</span>,ROC15) ;</div><div class="line">ROC30 &lt;- ROC(XYZQ$Close, n = <span class="number">30</span>,type =<span class="string">"discrete"</span>)*<span class="number">100</span> ; ROC30 &lt;- c(<span class="literal">NA</span>,ROC30) ;</div><div class="line">ROC45 &lt;- ROC(XYZQ$Close, n = <span class="number">45</span>,type =<span class="string">"discrete"</span>)*<span class="number">100</span> ; ROC45 &lt;- c(<span class="literal">NA</span>,ROC45) ;</div><div class="line">ROC60 &lt;- ROC(XYZQ$Close, n = <span class="number">60</span>,type =<span class="string">"discrete"</span>)*<span class="number">100</span> ; ROC60 &lt;- c(<span class="literal">NA</span>,ROC60) ;</div><div class="line">MOM5 &lt;- momentum(XYZQ$Close, n = <span class="number">5</span>, na.pad = <span class="literal">TRUE</span>) ; MOM5 &lt;- c(<span class="literal">NA</span>,MOM5) ;</div><div class="line">MOM10 &lt;- momentum(XYZQ$Close, n = <span class="number">10</span>, na.pad = <span class="literal">TRUE</span>) ; MOM10 &lt;- c(<span class="literal">NA</span>,MOM10) ;</div><div class="line">MOM15 &lt;- momentum(XYZQ$Close, n = <span class="number">15</span>, na.pad = <span class="literal">TRUE</span>) ; MOM15 &lt;- c(<span class="literal">NA</span>,MOM15) ;</div><div class="line">MOM30 &lt;- momentum(XYZQ$Close, n = <span class="number">30</span>, na.pad = <span class="literal">TRUE</span>) ; MOM30 &lt;- c(<span class="literal">NA</span>,MOM30) ;</div><div class="line">MOM45 &lt;- momentum(XYZQ$Close, n = <span class="number">45</span>, na.pad = <span class="literal">TRUE</span>) ; MOM45 &lt;- c(<span class="literal">NA</span>,MOM45) ;</div><div class="line">MOM60 &lt;- momentum(XYZQ$Close, n = <span class="number">60</span>, na.pad = <span class="literal">TRUE</span>) ; MOM60 &lt;- c(<span class="literal">NA</span>,MOM60) ;</div><div class="line">ATR5 &lt;- ATR(XYZQ[,c(<span class="string">"High"</span>,<span class="string">"Low"</span>,<span class="string">"Close"</span>)], n = <span class="number">5</span>, maType=<span class="string">"WMA"</span>)[,<span class="number">1</span>] ; ATR5 &lt;- c(<span class="literal">NA</span>,ATR5) ;</div><div class="line">ATR10 &lt;- ATR(XYZQ[,c(<span class="string">"High"</span>,<span class="string">"Low"</span>,<span class="string">"Close"</span>)], n = <span class="number">10</span>, maType=<span class="string">"WMA"</span>)[,<span class="number">1</span>]; ATR10 &lt;- c(<span class="literal">NA</span>,ATR10) ;</div><div class="line">ATR15 &lt;- ATR(XYZQ[,c(<span class="string">"High"</span>,<span class="string">"Low"</span>,<span class="string">"Close"</span>)], n = <span class="number">15</span>, maType=<span class="string">"WMA"</span>)[,<span class="number">1</span>]; ATR15 &lt;- c(<span class="literal">NA</span>,ATR15) ;</div><div class="line">ATR30 &lt;- ATR(XYZQ[,c(<span class="string">"High"</span>,<span class="string">"Low"</span>,<span class="string">"Close"</span>)], n = <span class="number">30</span>, maType=<span class="string">"WMA"</span>)[,<span class="number">1</span>] ; ATR30 &lt;- c(<span class="literal">NA</span>,ATR30) ;</div><div class="line">ATR45 &lt;- ATR(XYZQ[,c(<span class="string">"High"</span>,<span class="string">"Low"</span>,<span class="string">"Close"</span>)], n = <span class="number">45</span>, maType=<span class="string">"WMA"</span>)[,<span class="number">1</span>]; ATR45 &lt;- c(<span class="literal">NA</span>,ATR45) ;</div><div class="line">ATR60 &lt;- ATR(XYZQ[,c(<span class="string">"High"</span>,<span class="string">"Low"</span>,<span class="string">"Close"</span>)], n = <span class="number">60</span>, maType=<span class="string">"WMA"</span>)[,<span class="number">1</span>]; ATR60 &lt;- c(<span class="literal">NA</span>,ATR60) ;</div><div class="line">Mean5 &lt;- runMean(Cl(XYZQ), n = <span class="number">5</span>);  Mean5 &lt;- c(<span class="literal">NA</span>,Mean5) ;</div><div class="line">Mean10 &lt;- runMean(Cl(XYZQ), n = <span class="number">10</span>);  Mean10 &lt;- c(<span class="literal">NA</span>,Mean10) ;</div><div class="line">Mean15 &lt;- runMean(Cl(XYZQ), n = <span class="number">15</span>);  Mean15 &lt;- c(<span class="literal">NA</span>,Mean15) ;</div><div class="line">Mean30 &lt;- runMean(Cl(XYZQ), n = <span class="number">30</span>);  Mean30 &lt;- c(<span class="literal">NA</span>,Mean30) ;</div><div class="line">Mean45 &lt;- runMean(Cl(XYZQ), n = <span class="number">45</span>);  Mean45 &lt;- c(<span class="literal">NA</span>,Mean45) ;</div><div class="line">Mean60 &lt;- runMean(Cl(XYZQ), n = <span class="number">60</span>);  Mean60 &lt;- c(<span class="literal">NA</span>,Mean60) ;</div><div class="line">SD5 &lt;- runSD(Cl(XYZQ), n = <span class="number">5</span>);  SD5 &lt;- c(<span class="literal">NA</span>,SD5) ;</div><div class="line">SD10 &lt;- runSD(Cl(XYZQ), n = <span class="number">10</span>);  SD10 &lt;- c(<span class="literal">NA</span>,SD10) ;</div><div class="line">SD15 &lt;- runSD(Cl(XYZQ), n = <span class="number">15</span>);  SD15 &lt;- c(<span class="literal">NA</span>,SD15) ;</div><div class="line">SD30 &lt;- runSD(Cl(XYZQ), n = <span class="number">30</span>);  SD30 &lt;- c(<span class="literal">NA</span>,SD30) ;</div><div class="line">SD45 &lt;- runSD(Cl(XYZQ), n = <span class="number">45</span>);  SD45 &lt;- c(<span class="literal">NA</span>,SD45) ;</div><div class="line">SD60 &lt;- runSD(Cl(XYZQ), n = <span class="number">60</span>);  SD60 &lt;- c(<span class="literal">NA</span>,SD60) ;</div><div class="line"><span class="comment"># 创建特征数据集</span></div><div class="line">mydataset &lt;- data.frame(Close,myATR,mySMI,myADX,myAroon,myBB,myChaikinVol,</div><div class="line">                        myCLV,myEMV,myMACD,myMFI,mySAR,myVolat,myCMO,myEMA,</div><div class="line">                        forceindex,WillR5,WillR10,WillR15,WillR30,WillR45,WillR60,</div><div class="line">                        RSI5,RSI10,RSI15,RSI30,RSI45,RSI60,</div><div class="line">                        ROC5,ROC10,ROC15,ROC30,ROC45,ROC60,</div><div class="line">                        MOM5,MOM10,MOM15,MOM30,MOM45,MOM60,</div><div class="line">                        ATR5,ATR10,ATR15,ATR30,ATR45,ATR60,</div><div class="line">                        Mean5,Mean10,Mean15,Mean30,Mean45,Mean60,</div><div class="line">                        SD5,SD10,SD15,SD30,SD45,SD60,zhenfu,huanshou)</div><div class="line">tail(mydataset)</div><div class="line">Close    myATR    mySMI    myADX myAroon      myBB myChaikinVol       myCLV</div><div class="line"><span class="number">2980</span>     <span class="number">1</span> <span class="number">3.541269</span> <span class="number">59.81687</span> <span class="number">28.90271</span>      <span class="number">55</span> <span class="number">0.7459216</span>   -<span class="number">1.1581303</span> -<span class="number">0.13945017</span></div><div class="line"><span class="number">2981</span>     <span class="number">0</span> <span class="number">3.494036</span> <span class="number">58.12533</span> <span class="number">28.46763</span>      <span class="number">55</span> <span class="number">0.7118186</span>    <span class="number">0.3881411</span>  <span class="number">0.01469229</span></div><div class="line"><span class="number">2982</span>     <span class="number">1</span> <span class="number">3.971604</span> <span class="number">49.35320</span> <span class="number">27.41221</span>      <span class="number">55</span> <span class="number">0.3746141</span>   -<span class="number">3.0420371</span> -<span class="number">0.15305081</span></div><div class="line"><span class="number">2983</span>     <span class="number">1</span> <span class="number">3.888633</span> <span class="number">39.81658</span> <span class="number">26.43217</span>      <span class="number">55</span> <span class="number">0.3783665</span>    <span class="number">0.2083101</span> -<span class="number">0.14148355</span></div><div class="line"><span class="number">2984</span>     <span class="number">1</span> <span class="number">3.946588</span> <span class="number">31.02765</span> <span class="number">25.88484</span>      <span class="number">55</span> <span class="number">0.3630058</span>   -<span class="number">0.8824859</span> -<span class="number">0.07552716</span></div><div class="line"><span class="number">2985</span>    <span class="literal">NA</span> <span class="number">3.955403</span> <span class="number">24.34497</span> <span class="number">24.82386</span>      <span class="number">55</span> <span class="number">0.4283426</span>   -<span class="number">6.2060752</span> -<span class="number">0.01131472</span></div><div class="line">             myEMV   myMACD    myMFI     mySAR   myVolat     myCMO         myEMA</div><div class="line"><span class="number">2980</span>  <span class="number">6.188251e-04</span> <span class="number">3.383335</span> <span class="number">82.26928</span>  <span class="number">98.32502</span> <span class="number">0.3562983</span> <span class="number">45.267176</span>  <span class="number">0.0008408088</span></div><div class="line"><span class="number">2981</span>  <span class="number">4.658566e-04</span> <span class="number">3.476127</span> <span class="number">77.92001</span>  <span class="number">99.45121</span> <span class="number">0.3493821</span> <span class="number">46.711260</span>  <span class="number">0.0028368738</span></div><div class="line"><span class="number">2982</span>  <span class="number">2.671371e-04</span> <span class="number">3.360701</span> <span class="number">65.19533</span> <span class="number">107.71000</span> <span class="number">0.3824663</span>  <span class="number">9.544950</span> -<span class="number">0.0153244706</span></div><div class="line"><span class="number">2983</span> -<span class="number">3.034233e-05</span> <span class="number">3.136216</span> <span class="number">63.25320</span> <span class="number">107.71000</span> <span class="number">0.3857953</span>  <span class="number">7.727144</span> -<span class="number">0.0096568672</span></div><div class="line"><span class="number">2984</span> -<span class="number">4.895251e-04</span> <span class="number">2.853403</span> <span class="number">55.06603</span> <span class="number">107.11200</span> <span class="number">0.4081373</span> -<span class="number">4.286628</span> -<span class="number">0.0072257430</span></div><div class="line"><span class="number">2985</span> -<span class="number">2.754052e-04</span> <span class="number">2.573196</span> <span class="number">52.62331</span> <span class="number">106.53792</span> <span class="number">0.3798513</span> -<span class="number">1.747815</span> -<span class="number">0.0022594600</span></div><div class="line">     forceindex    WillR5   WillR10   WillR15   WillR30   WillR45   WillR60</div><div class="line"><span class="number">2980</span>  -<span class="number">49171519</span> <span class="number">0.9265367</span> <span class="number">0.4537445</span> <span class="number">0.2915094</span> <span class="number">0.2915094</span> <span class="number">0.2086428</span> <span class="number">0.2052474</span></div><div class="line"><span class="number">2981</span>   <span class="number">37598803</span> <span class="number">0.6693548</span> <span class="number">0.4055375</span> <span class="number">0.2580311</span> <span class="number">0.2349057</span> <span class="number">0.1681296</span> <span class="number">0.1653936</span></div><div class="line"><span class="number">2982</span>   <span class="number">34075913</span> <span class="number">0.9854772</span> <span class="number">0.9861478</span> <span class="number">0.7746114</span> <span class="number">0.7051887</span> <span class="number">0.5047265</span> <span class="number">0.4965128</span></div><div class="line"><span class="number">2983</span>   <span class="number">49447684</span> <span class="number">0.8772827</span> <span class="number">0.8891821</span> <span class="number">0.8067026</span> <span class="number">0.6358491</span> <span class="number">0.4550979</span> <span class="number">0.4476918</span></div><div class="line"><span class="number">2984</span>   <span class="number">11659692</span> <span class="number">0.7752545</span> <span class="number">0.8206250</span> <span class="number">0.7857570</span> <span class="number">0.6193396</span> <span class="number">0.4432816</span> <span class="number">0.4360678</span></div><div class="line"><span class="number">2985</span>   <span class="number">55125928</span> <span class="number">0.5830420</span> <span class="number">0.7018750</span> <span class="number">0.7018750</span> <span class="number">0.5297170</span> <span class="number">0.4060014</span> <span class="number">0.3755853</span></div><div class="line">          RSI5    RSI10    RSI15    RSI30    RSI45    RSI60       ROC5     ROC10</div><div class="line"><span class="number">2980</span> <span class="number">21.975737</span> <span class="number">51.34959</span> <span class="number">62.96328</span> <span class="number">63.85533</span> <span class="number">63.19654</span> <span class="number">62.64153</span>  -<span class="number">1.168111</span>  <span class="number">5.848624</span></div><div class="line"><span class="number">2981</span> <span class="number">31.805274</span> <span class="number">54.59128</span> <span class="number">64.75479</span> <span class="number">65.85176</span> <span class="number">64.42324</span> <span class="number">63.65843</span>  -<span class="number">3.367510</span>  <span class="number">5.863561</span></div><div class="line"><span class="number">2982</span>  <span class="number">8.578284</span> <span class="number">23.67412</span> <span class="number">36.13496</span> <span class="number">46.71875</span> <span class="number">50.26581</span> <span class="number">52.31439</span> -<span class="number">11.866983</span> -<span class="number">3.785914</span></div><div class="line"><span class="number">2983</span> <span class="number">19.109948</span> <span class="number">27.06896</span> <span class="number">38.44325</span> <span class="number">48.65479</span> <span class="number">51.67119</span> <span class="number">53.47462</span> -<span class="number">11.246115</span> -<span class="number">2.895713</span></div><div class="line"><span class="number">2984</span> <span class="number">24.012449</span> <span class="number">25.28028</span> <span class="number">37.25706</span> <span class="number">48.82718</span> <span class="number">51.85549</span> <span class="number">53.64726</span>  -<span class="number">8.494582</span> -<span class="number">7.428795</span></div><div class="line"><span class="number">2985</span> <span class="number">45.294925</span> <span class="number">33.95349</span> <span class="number">41.28556</span> <span class="number">51.58082</span> <span class="number">53.73532</span> <span class="number">55.13925</span>  -<span class="number">4.973899</span> -<span class="number">6.083909</span></div><div class="line">          ROC15     ROC30    ROC45    ROC60   MOM5 MOM10 MOM15 MOM30 MOM45 MOM60</div><div class="line"><span class="number">2980</span> <span class="number">13.5809375</span>  <span class="number">9.125107</span> <span class="number">19.78528</span> <span class="number">22.63558</span>  -<span class="number">1.20</span>  <span class="number">5.61</span> <span class="number">12.14</span>  <span class="number">8.49</span> <span class="number">16.77</span> <span class="number">18.74</span></div><div class="line"><span class="number">2981</span> <span class="number">14.5645143</span> <span class="number">12.890110</span> <span class="number">22.32674</span> <span class="number">23.14793</span>  -<span class="number">3.58</span>  <span class="number">5.69</span> <span class="number">13.06</span> <span class="number">11.73</span> <span class="number">18.75</span> <span class="number">19.31</span></div><div class="line"><span class="number">2982</span>  <span class="number">2.8837622</span>  <span class="number">4.837251</span> <span class="number">11.01005</span> <span class="number">14.06788</span> -<span class="number">12.49</span> -<span class="number">3.65</span>  <span class="number">2.60</span>  <span class="number">4.28</span>  <span class="number">9.20</span> <span class="number">11.44</span></div><div class="line"><span class="number">2983</span>  <span class="number">5.4970891</span>  <span class="number">6.752011</span> <span class="number">12.67488</span> <span class="number">18.96225</span> -<span class="number">11.94</span> -<span class="number">2.81</span>  <span class="number">4.91</span>  <span class="number">5.96</span> <span class="number">10.60</span> <span class="number">15.02</span></div><div class="line"><span class="number">2984</span>  <span class="number">3.3661202</span>  <span class="number">4.014077</span> <span class="number">13.28303</span> <span class="number">19.19345</span>  -<span class="number">8.78</span> -<span class="number">7.59</span>  <span class="number">3.08</span>  <span class="number">3.65</span> <span class="number">11.09</span> <span class="number">15.23</span></div><div class="line"><span class="number">2985</span>  <span class="number">0.5838198</span>  <span class="number">4.404285</span> <span class="number">18.94957</span> <span class="number">23.66060</span>  -<span class="number">5.05</span> -<span class="number">6.25</span>  <span class="number">0.56</span>  <span class="number">4.07</span> <span class="number">15.37</span> <span class="number">18.46</span></div><div class="line">      ATR5 ATR10 ATR15 ATR30 ATR45 ATR60   Mean5  Mean10   Mean15   Mean30   Mean45</div><div class="line"><span class="number">2980</span>  <span class="number">3.44</span>  <span class="number">3.44</span>  <span class="number">3.44</span>  <span class="number">3.44</span>  <span class="number">3.44</span>  <span class="number">3.44</span> <span class="number">104.524</span> <span class="number">101.801</span> <span class="number">98.30533</span> <span class="number">94.60333</span> <span class="number">92.10244</span></div><div class="line"><span class="number">2981</span>  <span class="number">2.88</span>  <span class="number">2.88</span>  <span class="number">2.88</span>  <span class="number">2.88</span>  <span class="number">2.88</span>  <span class="number">2.88</span> <span class="number">103.808</span> <span class="number">102.370</span> <span class="number">99.17600</span> <span class="number">94.99433</span> <span class="number">92.51911</span></div><div class="line"><span class="number">2982</span> <span class="number">10.18</span> <span class="number">10.18</span> <span class="number">10.18</span> <span class="number">10.18</span> <span class="number">10.18</span> <span class="number">10.18</span> <span class="number">101.310</span> <span class="number">102.005</span> <span class="number">99.34933</span> <span class="number">95.13700</span> <span class="number">92.72356</span></div><div class="line"><span class="number">2983</span>  <span class="number">2.81</span>  <span class="number">2.81</span>  <span class="number">2.81</span>  <span class="number">2.81</span>  <span class="number">2.81</span>  <span class="number">2.81</span>  <span class="number">98.922</span> <span class="number">101.724</span> <span class="number">99.67667</span> <span class="number">95.33567</span> <span class="number">92.95911</span></div><div class="line"><span class="number">2984</span>  <span class="number">4.70</span>  <span class="number">4.70</span>  <span class="number">4.70</span>  <span class="number">4.70</span>  <span class="number">4.70</span>  <span class="number">4.70</span>  <span class="number">97.166</span> <span class="number">100.965</span> <span class="number">99.88200</span> <span class="number">95.45733</span> <span class="number">93.20556</span></div><div class="line"><span class="number">2985</span>  <span class="number">4.07</span>  <span class="number">4.07</span>  <span class="number">4.07</span>  <span class="number">4.07</span>  <span class="number">4.07</span>  <span class="number">4.07</span>  <span class="number">96.156</span> <span class="number">100.340</span> <span class="number">99.91933</span> <span class="number">95.59300</span> <span class="number">93.54711</span></div><div class="line">       Mean60      SD5     SD10     SD15     SD30     SD45     SD60 zhenfu huanshou</div><div class="line"><span class="number">2980</span> <span class="number">89.86567</span> <span class="number">2.046040</span> <span class="number">3.789094</span> <span class="number">6.124109</span> <span class="number">5.798568</span> <span class="number">6.304757</span> <span class="number">6.834129</span>   <span class="number">3.33</span>    <span class="number">0.861</span></div><div class="line"><span class="number">2981</span> <span class="number">90.18750</span> <span class="number">1.884840</span> <span class="number">3.402179</span> <span class="number">5.724033</span> <span class="number">5.940947</span> <span class="number">6.374945</span> <span class="number">6.978591</span>   <span class="number">2.83</span>    <span class="number">0.774</span></div><div class="line"><span class="number">2982</span> <span class="number">90.37817</span> <span class="number">5.074185</span> <span class="number">4.212042</span> <span class="number">5.465018</span> <span class="number">5.829461</span> <span class="number">6.226899</span> <span class="number">6.887901</span>   <span class="number">4.44</span>    <span class="number">4.010</span></div><div class="line"><span class="number">2983</span> <span class="number">90.62850</span> <span class="number">5.024527</span> <span class="number">4.650943</span> <span class="number">4.943558</span> <span class="number">5.687187</span> <span class="number">6.073691</span> <span class="number">6.746620</span>   <span class="number">2.65</span>    <span class="number">1.090</span></div><div class="line"><span class="number">2984</span> <span class="number">90.88233</span> <span class="number">4.602253</span> <span class="number">5.161378</span> <span class="number">4.633946</span> <span class="number">5.628425</span> <span class="number">5.903346</span> <span class="number">6.600000</span>   <span class="number">4.99</span>    <span class="number">1.030</span></div><div class="line"><span class="number">2985</span> <span class="number">91.19000</span> <span class="number">3.906678</span> <span class="number">5.300442</span> <span class="number">4.601892</span> <span class="number">5.601426</span> <span class="number">5.625728</span> <span class="number">6.418002</span>   <span class="number">4.30</span>    <span class="number">0.570</span></div><div class="line">print(dim(mydataset))</div><div class="line">[<span class="number">1</span>] <span class="number">2985</span>   <span class="number">60</span></div><div class="line"><span class="comment"># data.test.tmp &lt;- mydataset[nrow(mydataset),]</span></div><div class="line">mydataset.tmp &lt;- na.omit(mydataset[<span class="number">1</span>:(nrow(mydataset)-<span class="number">1</span>),])</div><div class="line">print(dim(mydataset.tmp))</div><div class="line">[<span class="number">1</span>] <span class="number">2923</span>   <span class="number">60</span></div><div class="line">y = mydataset.tmp$Close</div><div class="line">cbind(freq=table(y), percentage=prop.table(table(y))*<span class="number">100</span>)</div><div class="line">  freq percentage</div><div class="line"><span class="number">0</span> <span class="number">1384</span>   <span class="number">47.34861</span></div><div class="line"><span class="number">1</span> <span class="number">1539</span>   <span class="number">52.65139</span></div><div class="line"><span class="comment"># correlations = cor(mydataset.tmp[,c(2:58)])</span></div><div class="line"><span class="comment"># print(head(correlations))</span></div><div class="line"><span class="comment"># corrplot(correlations, method="circle")</span></div><div class="line">set.seed(<span class="number">5</span>)</div><div class="line">weights &lt;- random.forest.importance(Close~., mydataset.tmp, importance.type = <span class="number">1</span>)</div><div class="line"><span class="comment"># 选取前十个权重较大的特征</span></div><div class="line">subset = cutoff.k(weights, <span class="number">10</span>)</div><div class="line">print(subset)</div><div class="line">[<span class="number">1</span>] <span class="string">"ROC45"</span>    <span class="string">"huanshou"</span> <span class="string">"WillR60"</span>  <span class="string">"Mean60"</span>   <span class="string">"SD15"</span>     <span class="string">"myCLV"</span>    <span class="string">"zhenfu"</span>  </div><div class="line"> [<span class="number">8</span>] <span class="string">"MOM60"</span>    <span class="string">"SD60"</span>     <span class="string">"myATR"</span></div></pre></td></tr></table></figure></p>
<h2 id="构建训练集、测试集"><a href="#构建训练集、测试集" class="headerlink" title="构建训练集、测试集"></a>构建训练集、测试集</h2><p>用选取出来的十个权重较大的特征构建训练集测试集<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">dataset_rf = data.frame(Close,mydataset[,subset[<span class="number">1</span>]],mydataset[,subset[<span class="number">2</span>]],</div><div class="line">                        mydataset[,subset[<span class="number">3</span>]],mydataset[,subset[<span class="number">4</span>]],</div><div class="line">                        mydataset[,subset[<span class="number">5</span>]],mydataset[,subset[<span class="number">6</span>]],</div><div class="line">                        mydataset[,subset[<span class="number">7</span>]],mydataset[,subset[<span class="number">8</span>]],</div><div class="line">                        mydataset[,subset[<span class="number">9</span>]],mydataset[,subset[<span class="number">10</span>]])</div><div class="line"></div><div class="line"><span class="comment"># write.csv(na.omit(dataset_rf),"XYZQ.csv", quote = F, row.names = F)</span></div><div class="line"><span class="comment"># 测试集</span></div><div class="line">data.test &lt;- dataset_rf[nrow(dataset_rf),]</div><div class="line"><span class="comment"># 训练集</span></div><div class="line">dataset_rf &lt;- na.omit(dataset_rf[<span class="number">1</span>:(nrow(dataset_rf)-<span class="number">1</span>),])</div><div class="line">dataset_rf$Close &lt;- factor(dataset_rf$Close)</div><div class="line"><span class="comment"># 十次交叉验证</span></div><div class="line">trainControl = trainControl(method=<span class="string">"cv"</span>, number=<span class="number">10</span>)</div><div class="line">metric = <span class="string">"Accuracy"</span></div></pre></td></tr></table></figure></p>
<h2 id="机器学习模型"><a href="#机器学习模型" class="headerlink" title="机器学习模型"></a>机器学习模型</h2><p>分别以<em>nnet</em>，<em>naive bayes</em>，<em>rpart</em>，<em>pcaNNet</em>，<em>svmRadial</em>，<em>gbm</em>，<em>xgbTree</em>七个模型进行训练测试<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># nnet</span></div><div class="line">fit.nnet = train(Close~., data=dataset_rf, method=<span class="string">"nnet"</span>, </div><div class="line">                 metric=metric, preProc=c(<span class="string">"range"</span>),trControl=trainControl)</div><div class="line"><span class="comment"># naive bayes</span></div><div class="line">fit.nb = train(Close~., data=dataset_rf, method=<span class="string">"nb"</span>, </div><div class="line">               metric=metric, preProc=c(<span class="string">"range"</span>),trControl=trainControl)</div><div class="line"><span class="comment"># rpart</span></div><div class="line">fit.rpart = train(Close~., data=dataset_rf, method=<span class="string">"rpart"</span>, </div><div class="line">                  metric=metric,preProc=c(<span class="string">"range"</span>),trControl=trainControl)</div><div class="line"><span class="comment"># pcaNNet</span></div><div class="line">fit.pcaNNet = train(Close~., data=dataset_rf, method=<span class="string">"pcaNNet"</span>, </div><div class="line">                    metric=metric, preProc=c(<span class="string">"range"</span>),trControl=trainControl)</div><div class="line"><span class="comment"># svmRadial</span></div><div class="line">fit.svmRadial = train(Close~., data=dataset_rf, method=<span class="string">"svmRadial"</span>, </div><div class="line">                      metric=metric,preProc=c(<span class="string">"range"</span>),trControl=trainControl)</div><div class="line"><span class="comment"># gbm</span></div><div class="line">fit.gbm = train(Close~., data=dataset_rf, method=<span class="string">"gbm"</span>, </div><div class="line">                metric=metric,preProc=c(<span class="string">"range"</span>),trControl=trainControl)</div><div class="line"><span class="comment"># xgbTree</span></div><div class="line">fit.xgbTree = train(Close~., data=dataset_rf, method=<span class="string">"xgbTree"</span>, </div><div class="line">                    metric=metric,preProc=c(<span class="string">"range"</span>),trControl=trainControl)</div><div class="line"></div><div class="line"><span class="comment">## Evaluating the algorithms using the "Accuracy" metric</span></div><div class="line">results = resamples(list(nnet=fit.nnet,nb=fit.nb,rpart=fit.rpart, </div><div class="line">                         pcaNNet=fit.pcaNNet, svmRadial=fit.svmRadial, </div><div class="line">                         gbm=fit.gbm, xgbTree=fit.xgbTree))</div><div class="line">summary(results)</div><div class="line">Call:</div><div class="line">summary.resamples(object = results)</div><div class="line"></div><div class="line">Models: nnet, nb, rpart, pcaNNet, svmRadial, gbm, xgbTree </div><div class="line">Number of resamples: <span class="number">10</span> </div><div class="line"></div><div class="line">Accuracy </div><div class="line">               Min.   1st Qu.    Median      Mean   3rd Qu.      Max. <span class="literal">NA</span><span class="string">'s</span></div><div class="line">nnet      0.5119454 0.5278005 0.5350531 0.5374879 0.5448303 0.5807560    0</div><div class="line">nb        0.4914676 0.5179795 0.5435738 0.5371219 0.5593500 0.5616438    0</div><div class="line">rpart     0.5034247 0.5239726 0.5299161 0.5289004 0.5376712 0.5426621    0</div><div class="line">pcaNNet   0.5034247 0.5226314 0.5273973 0.5299406 0.5439741 0.5582192    0</div><div class="line">svmRadial 0.5034247 0.5106918 0.5188356 0.5264996 0.5445205 0.5631399    0</div><div class="line">gbm       0.5017065 0.5393836 0.5462329 0.5473935 0.5571672 0.5890411    0</div><div class="line">xgbTree   0.5119454 0.5397722 0.5487166 0.5545761 0.5758279 0.5972696    0</div><div class="line"></div><div class="line">Kappa </div><div class="line">                  Min.      1st Qu.     Median       Mean    3rd Qu.       Max. NA's</div><div class="line">nnet      -<span class="number">0.018275937</span>  <span class="number">0.019774954</span> <span class="number">0.03377084</span> <span class="number">0.03687602</span> <span class="number">0.05092740</span> <span class="number">0.12767212</span>    <span class="number">0</span></div><div class="line">nb        -<span class="number">0.054848141</span> -<span class="number">0.001926439</span> <span class="number">0.05667858</span> <span class="number">0.04044339</span> <span class="number">0.08712856</span> <span class="number">0.09197804</span>    <span class="number">0</span></div><div class="line">rpart     -<span class="number">0.019553073</span>  <span class="number">0.018301156</span> <span class="number">0.03064388</span> <span class="number">0.02607515</span> <span class="number">0.03487674</span> <span class="number">0.06389776</span>    <span class="number">0</span></div><div class="line">pcaNNet   -<span class="number">0.037948617</span>  <span class="number">0.001225074</span> <span class="number">0.02214420</span> <span class="number">0.02116072</span> <span class="number">0.04925753</span> <span class="number">0.07875171</span>    <span class="number">0</span></div><div class="line">svmRadial -<span class="number">0.029068637</span> -<span class="number">0.010983769</span> <span class="number">0.00421168</span> <span class="number">0.01941413</span> <span class="number">0.05314826</span> <span class="number">0.09151688</span>    <span class="number">0</span></div><div class="line">gbm       -<span class="number">0.015573809</span>  <span class="number">0.060255860</span> <span class="number">0.07418475</span> <span class="number">0.07746468</span> <span class="number">0.09846185</span> <span class="number">0.16428163</span>    <span class="number">0</span></div><div class="line">xgbTree    <span class="number">0.004939796</span>  <span class="number">0.062262588</span> <span class="number">0.07858693</span> <span class="number">0.09198844</span> <span class="number">0.13641100</span> <span class="number">0.17330592</span>    <span class="number">0</span></div></pre></td></tr></table></figure></p>
<p>dotplot(results)<br><img src="http://wx1.sinaimg.cn/mw690/e621a9abgy1fgva799vyij20hq0cxdhj.jpg" alt="image"></p>
<h2 id="预测涨跌"><a href="#预测涨跌" class="headerlink" title="预测涨跌"></a>预测涨跌</h2><p>首先根据每个模型的预测效果的平均数，计算出每个模型的权重，再根据这个权重计算出最终的涨跌概率。有点类似于7个常委进行民主投票进行最终的决策。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">pres.pcaNNet &lt;- predict(fit.pcaNNet, data.test)</div><div class="line">pres.nnet &lt;- predict(fit.nnet, data.test)</div><div class="line">pres.xgbTree &lt;- predict(fit.xgbTree, data.test)</div><div class="line">pres.svmRadial &lt;- predict(fit.svmRadial, data.test)</div><div class="line">pres.gbm &lt;- predict(fit.gbm, data.test)</div><div class="line">pres.nb &lt;- predict(fit.nb, data.test)</div><div class="line">pres.rpart &lt;- predict(fit.rpart, data.test)</div><div class="line">pres.pcaNNet &lt;- as.numeric(as.character(pres.pcaNNet))</div><div class="line">pres.nnet &lt;- as.numeric(as.character(pres.nnet))</div><div class="line">pres.xgbTree &lt;- as.numeric(as.character(pres.xgbTree))</div><div class="line">pres.svmRadial &lt;- as.numeric(as.character(pres.svmRadial))</div><div class="line">pres.gbm &lt;- as.numeric(as.character(pres.gbm))</div><div class="line">pres.nb &lt;- as.numeric(as.character(pres.nb))</div><div class="line">pres.rpart &lt;- as.numeric(as.character(pres.rpart))</div><div class="line">pres &lt;- data.frame(pres.pcaNNet,pres.nnet,pres.xgbTree,pres.svmRadial,pres.gbm,pres.nb,pres.rpart) </div><div class="line">pres</div><div class="line">pres.pcaNNet pres.nnet pres.xgbTree pres.svmRadial pres.gbm pres.nb pres.rpart</div><div class="line"><span class="number">1</span>            <span class="number">1</span>         <span class="number">1</span>            <span class="number">0</span>              <span class="number">1</span>        <span class="number">0</span>       <span class="number">0</span>          <span class="number">1</span></div><div class="line"><span class="comment"># names(getModelInfo())</span></div><div class="line">results.acc &lt;- as.data.frame(summary(results)[<span class="number">3</span>]$statistics$Accuracy)</div><div class="line">mean.sum &lt;- sum(results.acc$Mean)</div><div class="line">mean.pcaNNet &lt;- results.acc[<span class="string">"pcaNNet"</span>,<span class="string">"Mean"</span>]</div><div class="line">mean.nnet &lt;- results.acc[<span class="string">"nnet"</span>,<span class="string">"Mean"</span>]</div><div class="line">mean.xgbTree &lt;- results.acc[<span class="string">"xgbTree"</span>,<span class="string">"Mean"</span>]</div><div class="line">mean.svmRadial &lt;- results.acc[<span class="string">"svmRadial"</span>,<span class="string">"Mean"</span>]</div><div class="line">mean.gbm &lt;- results.acc[<span class="string">"gbm"</span>,<span class="string">"Mean"</span>]</div><div class="line">mean.nb &lt;- results.acc[<span class="string">"nb"</span>,<span class="string">"Mean"</span>]</div><div class="line">mean.rpart &lt;- results.acc[<span class="string">"rpart"</span>,<span class="string">"Mean"</span>]</div><div class="line"><span class="comment"># 加入权重计算涨跌概率</span></div><div class="line">q.pcaNNet &lt;- (mean.pcaNNet / mean.sum) * nrow(results.acc)</div><div class="line">q.nnet &lt;- (mean.nnet / mean.sum) * nrow(results.acc)</div><div class="line">q.xgbTree &lt;- (mean.xgbTree / mean.sum) * nrow(results.acc)</div><div class="line">q.svmRadial &lt;- (mean.svmRadial / mean.sum) * nrow(results.acc)</div><div class="line">q.gbm &lt;- (mean.gbm / mean.sum) * nrow(results.acc)</div><div class="line">q.nb &lt;- (mean.nb / mean.sum) * nrow(results.acc)</div><div class="line">q.rpart &lt;- (mean.rpart / mean.sum) * nrow(results.acc)</div><div class="line"><span class="comment"># 最终的预测结果</span></div><div class="line">p.result &lt;- mean(c(pres.pcaNNet*q.pcaNNet,pres.nnet*q.nnet,pres.xgbTree*q.xgbTree,pres.svmRadial*q.svmRadial,pres.gbm*q.gbm,pres.nb*q.nb,pres.rpart*q.rpart))</div><div class="line">p.result</div><div class="line">[<span class="number">1</span>] <span class="number">0.5642939</span></div></pre></td></tr></table></figure></p>
<p>最终计算出的今日涨跌概率为0.56，超出了0.5，那么可以认为，今天的<em>分众传媒</em>的预测结果为涨。实际上，分众传媒今天上涨了0.45%，这是巧合吗？有待进一步的探索。如设置止损点、挖掘更有效的特征以及配合蒙特卡洛方法。</p>
</div><div class="tags"><a href="/tags/量化金融/">量化金融</a><a href="/tags/股票预测/">股票预测</a><a href="/tags/机器学习/">机器学习</a><a href="/tags/特征选取/">特征选取</a></div><div class="post-share"><div class="jiathis_style"><span class="jiathis_txt">分享到：</span><a class="jiathis_button_tsina"></a><a class="jiathis_button_qzone"></a><a class="jiathis_button_weixin"></a><a class="jiathis_button_fb"></a><a class="jiathis_button_linkedin"></a><a class="jiathis_button_twitter"></a><a class="jiathis_button_ydnote"></a><a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis"></a><a class="jiathis_counter_style"></a></div></div><div class="post-nav"><a href="/2017/07/11/R中的大数据分析/" class="pre">R中的大数据分析</a><a href="/2017/07/11/hello-world/" class="next">Hello World</a></div><div id="comments"><div id="uyan_frame"></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#数据准备"><span class="toc-text">数据准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据预处理"><span class="toc-text">数据预处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#特征提取"><span class="toc-text">特征提取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#构建训练集、测试集"><span class="toc-text">构建训练集、测试集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#机器学习模型"><span class="toc-text">机器学习模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#预测涨跌"><span class="toc-text">预测涨跌</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/11/10/译：机器学习算法要点（附Python和R代码）/">译：机器学习算法要点（附Python和R代码）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/23/侦测欺诈交易/">侦测欺诈交易</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/18/购物篮关联规则分析/">购物篮关联规则分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/01/R中如何对量化策略进行回测/">R中如何对量化策略进行回测</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/11/R中的大数据分析/">R中的大数据分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/11/R机器学习之股票预测初探/">R机器学习之股票预测初探</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/11/hello-world/">Hello World</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/R/">R</a><span class="category-list-count">5</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/离群值侦测排序/" style="font-size: 15px;">离群值侦测排序</a> <a href="/tags/量化金融/" style="font-size: 15px;">量化金融</a> <a href="/tags/大数据/" style="font-size: 15px;">大数据</a> <a href="/tags/聚类/" style="font-size: 15px;">聚类</a> <a href="/tags/线性回归/" style="font-size: 15px;">线性回归</a> <a href="/tags/股票预测/" style="font-size: 15px;">股票预测</a> <a href="/tags/机器学习/" style="font-size: 15px;">机器学习</a> <a href="/tags/特征选取/" style="font-size: 15px;">特征选取</a> <a href="/tags/欺诈侦测/" style="font-size: 15px;">欺诈侦测</a> <a href="/tags/半监督分类/" style="font-size: 15px;">半监督分类</a> <a href="/tags/类失衡/" style="font-size: 15px;">类失衡</a> <a href="/tags/贝叶斯分类器/" style="font-size: 15px;">贝叶斯分类器</a> <a href="/tags/AdaBoost分类器/" style="font-size: 15px;">AdaBoost分类器</a> <a href="/tags/决策精确度/" style="font-size: 15px;">决策精确度</a> <a href="/tags/回溯精确度/" style="font-size: 15px;">回溯精确度</a> <a href="/tags/交叉验证/" style="font-size: 15px;">交叉验证</a> <a href="/tags/回测/" style="font-size: 15px;">回测</a> <a href="/tags/逻辑回归/" style="font-size: 15px;">逻辑回归</a> <a href="/tags/决策树/" style="font-size: 15px;">决策树</a> <a href="/tags/支持向量机/" style="font-size: 15px;">支持向量机</a> <a href="/tags/朴素贝叶斯/" style="font-size: 15px;">朴素贝叶斯</a> <a href="/tags/最近邻（KNN）/" style="font-size: 15px;">最近邻（KNN）</a> <a href="/tags/K-均值/" style="font-size: 15px;">K-均值</a> <a href="/tags/随机森林/" style="font-size: 15px;">随机森林</a> <a href="/tags/降维算法/" style="font-size: 15px;">降维算法</a> <a href="/tags/梯度下降算法/" style="font-size: 15px;">梯度下降算法</a> <a href="/tags/GBM/" style="font-size: 15px;">GBM</a> <a href="/tags/XGBoost/" style="font-size: 15px;">XGBoost</a> <a href="/tags/LightGBM/" style="font-size: 15px;">LightGBM</a> <a href="/tags/CatBoost/" style="font-size: 15px;">CatBoost</a> <a href="/tags/购物篮/" style="font-size: 15px;">购物篮</a> <a href="/tags/关联规则/" style="font-size: 15px;">关联规则</a> <a href="/tags/推荐算法/" style="font-size: 15px;">推荐算法</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="http://weibo.com/youthcolor" title="Geekdreams" target="_blank">Geekdreams</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">youthcolor.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>var jiathis_config={
    data_track_clickback:true,
    summary:"",
    shortUrl:true,
    hideMore:false
}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script><script src="http://v2.uyan.cc/code/uyan.js?uid=2136627"></script></body></html>