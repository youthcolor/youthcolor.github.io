<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="youthcolor's blog"><title>使用H2O和data.table构建R大数据集模型 | Geekdreams</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">使用H2O和data.table构建R大数据集模型</h1><a id="logo" href="/.">Geekdreams</a><p class="description">Nothing is difficult to the man who will try.</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">使用H2O和data.table构建R大数据集模型</h1><div class="post-meta"><a href="/2017/11/30/使用H2O和data.table构建R大数据集模型/#comments" class="comment-count"><a id="uyan_count_unit" href="/2017/11/30/使用H2O和data.table构建R大数据集模型/"></a>留言</a><p><span class="date">Nov 30, 2017</span><span><a href="/categories/R/" class="category">R</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><h2 id="引文"><a href="#引文" class="headerlink" title="引文"></a>引文</h2><p>上周，我写了一篇关于data.table包的介绍性文章。它的目的是为您提供一个良好的开端，并熟悉它的独特和简短的语法。下一步是关注建模，我们将在今天的文章中做建模。</p>
<p>有了data.table，您不再需要担心您的机器没有足够的RAM。至少，在面对大型数据集时，我曾经认为自己是一个瘫痪的R用户。但不会有这种担心了，再次感谢<a href="https://www.linkedin.com/in/mattdowle" target="_blank" rel="external">Matt Dowle</a>的做出的贡献。<br><a id="more"></a><br>上周，我收到一封邮件说:“好的,我明白了。data.table使我们能够进行数据的探索和操作。但是，模型构建呢?我的RAM为8G。像随机森林(ntrees=1000)这样的算法需要花费太长时间来运行80万行数据集。”</p>
<p>我确信有很多的R用户被困在类似的情况下。为了克服这一艰难的障碍，我决定编写这篇文章，它演示了如何使用两个最强大的包，即H2O和data.table。</p>
<p>为了达到实用性的理解，我从一个<a href="http://datahack.analyticsvidhya.com/contest/black-friday" target="_blank" rel="external">实践问题</a>中获取了数据，并尝试使用4种不同的机器学习算法(H2O)和特性工程(使用data.table)来提高分数。所以，在排行榜上准备好从排行第154位到排行第25位的旅程。</p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li>H2O简介</li>
<li>为什么它如此快</li>
<li>实战开始</li>
<li>使用data.table和ggplot进行数据探索</li>
<li>使用data.table处理数据</li>
<li>使用H2O构建模型<ul>
<li>回归</li>
<li>随机森林</li>
<li>GBM</li>
<li>深度学习</li>
</ul>
</li>
</ol>
<p>注意:将本文作为使用data.table和H2O进行数据模型构建的初学者指南。我还没有详细解释这些算法。相反，我们关注的焦点是如何使用H2O来实现这些算法。别担心，资源和链接都会提供的。</p>
<h2 id="H2O简介"><a href="#H2O简介" class="headerlink" title="H2O简介"></a>H2O简介</h2><p><a href="http://www.h2o.ai/" target="_blank" rel="external">H2O</a>是一个开源机器学习平台，企业可以在大型数据集(无采样需求)上建立模型，并实现准确的预测。它的速度非常快，可伸缩，并且很容易实现。</p>
<p>简而言之，它们为企业提供了一个GUI驱动的平台，以便进行更快的数据计算。目前，他们的平台支持高级和基本的机器学习算法，如深度学习、提升、装袋、朴素贝叶斯、主成分分析、时间序列、k-均值、广义线性模型。</p>
<p>此外，H2O还为R、Python、Spark和Hadoop用户提供了api，让我们这样的人可以使用它在各个层次上构建模型。它可以自由使用，并加快计算速度。</p>
<h2 id="为什么它如此快"><a href="#为什么它如此快" class="headerlink" title="为什么它如此快"></a>为什么它如此快</h2><p>H2O有一个干净而清晰的特性，可以直接将工具(R或Python)与您的计算机的CPU连接起来。这样我们就可以获得更多的内存，处理更快速的计算工具的能力。这将允许计算以100%的CPU容量进行(如下所示)。它还可以在云平台的集群上进行计算。</p>
<p>此外，它还使用内存中的压缩来处理大型数据集，即使有一个小的集群。它还提供了并行分布式式网络训练的支持。</p>
<h2 id="实战开始"><a href="#实战开始" class="headerlink" title="实战开始"></a>实战开始</h2><p>数据集:我从黑色星期五的实践问题中获取数据。数据集有两部分:训练集和测试集。训练数据集包含550068个观测数据。测试数据集包含233599个观察结果。下载数据并阅读问题声明:<a href="https://datahack.analyticsvidhya.com/contest/black-friday/" target="_blank" rel="external">点击这里</a>。需要登录。</p>
<p>理想情况下，模型构建的第一步是生成假设。在您阅读了问题陈述之后，但是没有看到数据，这一步是有必要的。</p>
<p>因为，这个指南并不是为了演示所有的预测建模步骤，所以我把它留给您。这里有一个很好的资源来更新你的基础知识:<a href="https://www.analyticsvidhya.com/blog/2015/09/hypothesis-testing-explained/" target="_blank" rel="external">假设生成向导</a>。如果你做了这一步，也许你最终会创造出比我更好的模型。尽你最大的努力。</p>
<p>H2O官网在R中安装H2O方法：<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># The following two commands remove any previously installed H2O packages for R.</span></div><div class="line"><span class="keyword">if</span> (<span class="string">"package:h2o"</span> %<span class="keyword">in</span>% search()) &#123; <span class="keyword">detach</span>(<span class="string">"package:h2o"</span>, unload=<span class="literal">TRUE</span>) &#125;</div><div class="line"><span class="keyword">if</span> (<span class="string">"h2o"</span> %<span class="keyword">in</span>% rownames(installed.packages())) &#123; remove.packages(<span class="string">"h2o"</span>) &#125;</div><div class="line"><span class="comment"># Next, we download packages that H2O depends on.</span></div><div class="line">pkgs &lt;- c(<span class="string">"RCurl"</span>,<span class="string">"jsonlite"</span>)</div><div class="line"><span class="keyword">for</span> (pkg <span class="keyword">in</span> pkgs) &#123;</div><div class="line">  <span class="keyword">if</span> (! (pkg %<span class="keyword">in</span>% rownames(installed.packages()))) &#123; install.packages(pkg) &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment"># Now we download, install and initialize the H2O package for R.</span></div><div class="line">install.packages(<span class="string">"h2o"</span>, type=<span class="string">"source"</span>, repos=<span class="string">"http://h2o-release.s3.amazonaws.com/h2o/rel-wheeler/1/R"</span>)</div><div class="line"><span class="comment"># Finally, let's load H2O and start up an H2O cluster</span></div><div class="line"><span class="keyword">library</span>(h2o)</div><div class="line">h2o.init()</div></pre></td></tr></table></figure></p>
<p>开始在R中加载数据<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">path &lt;- <span class="string">"D:\\用户目录\\下载"</span></div><div class="line">setwd(path)</div><div class="line"><span class="comment">#install and load the package</span></div><div class="line">install.packages(<span class="string">"data.table"</span>)</div><div class="line"><span class="keyword">library</span>(data.table)</div><div class="line"><span class="comment">#load data using fread</span></div><div class="line">train &lt;- fread(<span class="string">"train.csv"</span>, stringsAsFactors = <span class="literal">T</span>)</div><div class="line">test &lt;- fread(<span class="string">"test.csv"</span>, stringsAsFactors = <span class="literal">T</span>)</div></pre></td></tr></table></figure></p>
<p>在几秒钟内，fread将数据加载到r中，速度很快。参数stringsAsFactors确保将字符向量转换为因子。让我们快速检查一下数据集。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">dim(train)</div><div class="line">[<span class="number">1</span>] <span class="number">550068</span>     <span class="number">12</span></div><div class="line"><span class="comment">#No. of rows and columns in Test</span></div><div class="line">dim(test)</div><div class="line">[<span class="number">1</span>] <span class="number">233599</span>     <span class="number">11</span></div><div class="line">str(train)</div><div class="line">Classes ‘data.table’ and <span class="string">'data.frame'</span>:	<span class="number">550068</span> obs. of  <span class="number">12</span> variables:</div><div class="line"> $ User_ID                   : int  <span class="number">1000001</span> <span class="number">1000001</span> <span class="number">1000001</span> <span class="number">1000001</span> <span class="number">1000002</span> <span class="number">1000003</span> <span class="number">1000004</span> <span class="number">1000004</span> <span class="number">1000004</span> <span class="number">1000005</span> <span class="keyword">...</span></div><div class="line"> $ Product_ID                : Factor w/ <span class="number">3631</span> levels <span class="string">"P00000142"</span>,<span class="string">"P00000242"</span>,..: <span class="number">673</span> <span class="number">2377</span> <span class="number">853</span> <span class="number">829</span> <span class="number">2735</span> <span class="number">1832</span> <span class="number">1746</span> <span class="number">3321</span> <span class="number">3605</span> <span class="number">2632</span> <span class="keyword">...</span></div><div class="line"> $ Gender                    : Factor w/ <span class="number">2</span> levels <span class="string">"F"</span>,<span class="string">"M"</span>: <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="keyword">...</span></div><div class="line"> $ Age                       : Factor w/ <span class="number">7</span> levels <span class="string">"0-17"</span>,<span class="string">"18-25"</span>,..: <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">7</span> <span class="number">3</span> <span class="number">5</span> <span class="number">5</span> <span class="number">5</span> <span class="number">3</span> <span class="keyword">...</span></div><div class="line"> $ Occupation                : int  <span class="number">10</span> <span class="number">10</span> <span class="number">10</span> <span class="number">10</span> <span class="number">16</span> <span class="number">15</span> <span class="number">7</span> <span class="number">7</span> <span class="number">7</span> <span class="number">20</span> <span class="keyword">...</span></div><div class="line"> $ City_Category             : Factor w/ <span class="number">3</span> levels <span class="string">"A"</span>,<span class="string">"B"</span>,<span class="string">"C"</span>: <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">3</span> <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">1</span> <span class="keyword">...</span></div><div class="line"> $ Stay_In_Current_City_Years: Factor w/ <span class="number">5</span> levels <span class="string">"0"</span>,<span class="string">"1"</span>,<span class="string">"2"</span>,<span class="string">"3"</span>,..: <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">2</span> <span class="keyword">...</span></div><div class="line"> $ Marital_Status            : int  <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="keyword">...</span></div><div class="line"> $ Product_Category_1        : int  <span class="number">3</span> <span class="number">1</span> <span class="number">12</span> <span class="number">12</span> <span class="number">8</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">8</span> <span class="keyword">...</span></div><div class="line"> $ Product_Category_2        : int  <span class="literal">NA</span> <span class="number">6</span> <span class="literal">NA</span> <span class="number">14</span> <span class="literal">NA</span> <span class="number">2</span> <span class="number">8</span> <span class="number">15</span> <span class="number">16</span> <span class="literal">NA</span> <span class="keyword">...</span></div><div class="line"> $ Product_Category_3        : int  <span class="literal">NA</span> <span class="number">14</span> <span class="literal">NA</span> <span class="literal">NA</span> <span class="literal">NA</span> <span class="literal">NA</span> <span class="number">17</span> <span class="literal">NA</span> <span class="literal">NA</span> <span class="literal">NA</span> <span class="keyword">...</span></div><div class="line"> $ Purchase                  : int  <span class="number">8370</span> <span class="number">15200</span> <span class="number">1422</span> <span class="number">1057</span> <span class="number">7969</span> <span class="number">15227</span> <span class="number">19215</span> <span class="number">15854</span> <span class="number">15686</span> <span class="number">7871</span> <span class="keyword">...</span></div><div class="line"> - attr(*, <span class="string">".internal.selfref"</span>)=&lt;externalptr&gt;</div></pre></td></tr></table></figure></p>
<p>我们看到了什么?我们看到了12个变量，其中2个看起来有那么多的NAs。如果你读过问题描述和数据信息，我们会看到购买是依赖变量，剩下11个是独立变量。</p>
<p>在购买变量(连续)的性质上，我们可以推断这是一个回归问题。尽管比赛已经结束了，但是我们仍然可以检查我们的分数，并评估我们的表现有多好。让我们第一次提交看看结果如何。</p>
<p>有了所有的数据点，我们可以用均值来做第一组预测。这是因为，平均预测会给我们一个很好的预测误差的近似值。将此作为基线预测，我们的模型不会比这更糟。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#first prediction using mean</span></div><div class="line">sub_mean &lt;- data.frame(User_ID = test$User_ID, Product_ID = test$Product_ID, Purchase = mean(train$Purchase))</div><div class="line">write.csv(sub_mean, file = <span class="string">"first_sub.csv"</span>, row.names = <span class="literal">F</span>)</div></pre></td></tr></table></figure></p>
<p>这个比较简单。现在，我将上传结果文件并检查我的分数和等级。别忘了转换csv。上传之前的压缩格式。你可以在竞争页面上上传和检查你的解决方案。</p>
<p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2016/05/21-1024x264.png" alt="image"></p>
<p>我们的平均预测给了我们一个均值的平方误差4982.3199。但是，它有多好呢?让我们来看看我在排行榜上的排名。</p>
<p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2016/05/22-1024x443.png" alt="image"></p>
<p>谢天谢地，我不是最后一个。所以，平均预测得到了154/162。让我们改进这一分数，并试图提升排行榜的排名。</p>
<p>在开始使用单变量分析之前，让我们快速地总结一下文件(训练集和测试集)和解释，如果存在任何差异的话。</p>
<p>仔细看(在结尾)，你看到他们的输出有什么不同吗?事实上,我发现了一个。如果你仔细比较产品类别1、产品类别2和产品类别的测试和训练数据，你就会在最大的价值上存在差异。产品分类的最大值是20，而其他的是18。这些额外的类别似乎是噪声。请注意这一点。我们需要移除它们。</p>
<p>让我们把数据集合并起来，我使用了来自data.table的rbindlist函数，因为它比rbind函数速度快。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#combine data set</span></div><div class="line">test[,Purchase := mean(train$Purchase)]</div><div class="line">c &lt;- list(train, test)</div><div class="line">combin &lt;- rbindlist(c)</div></pre></td></tr></table></figure></p>
<p>在上面的代码中，我们首先在测试集中添加了购买变量，这样两个数据集都有相同数量的列。现在，我们来做一些数据探索。</p>
<h2 id="使用data-table和ggplot进行数据探索"><a href="#使用data-table和ggplot进行数据探索" class="headerlink" title="使用data.table和ggplot进行数据探索"></a>使用data.table和ggplot进行数据探索</h2><p>在本节中，我们将做一些单变量和变量对分析，并尝试理解给定变量之间的关系。让我们先从单变量开始。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#analyzing gender variable</span></div><div class="line">combin[,prop.table(table(Gender))]</div><div class="line">Gender</div><div class="line">        <span class="literal">F</span>         M </div><div class="line"><span class="number">0.2470896</span> <span class="number">0.7529104</span> </div><div class="line"><span class="comment">#Age Variable</span></div><div class="line">combin[,prop.table(table(Age))]</div><div class="line">Age</div><div class="line">      <span class="number">0</span>-<span class="number">17</span>      <span class="number">18</span>-<span class="number">25</span>      <span class="number">26</span>-<span class="number">35</span>      <span class="number">36</span>-<span class="number">45</span>      <span class="number">46</span>-<span class="number">50</span>      <span class="number">51</span>-<span class="number">55</span>        <span class="number">55</span>+ </div><div class="line"><span class="number">0.02722330</span> <span class="number">0.18113944</span> <span class="number">0.39942348</span> <span class="number">0.19998801</span> <span class="number">0.08329814</span> <span class="number">0.06990724</span> <span class="number">0.03902040</span> </div><div class="line"><span class="comment">#City Category Variable</span></div><div class="line">combin[,prop.table(table(City_Category))]</div><div class="line">City_Category</div><div class="line">        A         B         C </div><div class="line"><span class="number">0.2682823</span> <span class="number">0.4207642</span> <span class="number">0.3109535</span> </div><div class="line"><span class="comment">#Stay in Current Years Variable</span></div><div class="line">combin[,prop.table(table(Stay_In_Current_City_Years))]</div><div class="line">Stay_In_Current_City_Years</div><div class="line">        <span class="number">0</span>         <span class="number">1</span>         <span class="number">2</span>         <span class="number">3</span>        <span class="number">4</span>+ </div><div class="line"><span class="number">0.1348991</span> <span class="number">0.3527327</span> <span class="number">0.1855724</span> <span class="number">0.1728132</span> <span class="number">0.1539825</span> </div><div class="line"><span class="comment">#unique values in ID variables</span></div><div class="line">length(unique(combin$Product_ID))</div><div class="line">[<span class="number">1</span>] <span class="number">3677</span></div><div class="line">length(unique(combin$User_ID))</div><div class="line">[<span class="number">1</span>] <span class="number">5891</span></div><div class="line"><span class="comment">#missing values</span></div><div class="line">colSums(is.na(combin))</div><div class="line">                   User_ID                 Product_ID                     Gender                        Age </div><div class="line">                         <span class="number">0</span>                          <span class="number">0</span>                          <span class="number">0</span>                          <span class="number">0</span> </div><div class="line">                Occupation              City_Category Stay_In_Current_City_Years             Marital_Status </div><div class="line">                         <span class="number">0</span>                          <span class="number">0</span>                          <span class="number">0</span>                          <span class="number">0</span> </div><div class="line">        Product_Category_1         Product_Category_2         Product_Category_3                   Purchase </div><div class="line">                         <span class="number">0</span>                     <span class="number">245982</span>                     <span class="number">545809</span>                          <span class="number">0</span></div></pre></td></tr></table></figure></p>
<p>以下是我们可以从单变量分析中得出的推论:</p>
<ol>
<li>我们需要将性别变量编码为0和1。</li>
<li>我们还需要分箱重新编码这个年龄变量。</li>
<li>由于在city category中有三个级别，所以我们可以进行一种热编码。</li>
<li>目前的“4+”水平需要重新评估。</li>
<li>数据集不包含所有惟一的id。这给了我们足够的特性工程的提示。</li>
<li>只有两个变量有缺失值。事实上，很多缺失值，可能是一种隐藏的趋势。我们需要以不同的方式对待他们。</li>
</ol>
<p>我们已经从单变量分析中得到了足够的提示。让我们快速地进行二元分析。通过添加更多参数，您可以使这些图表看起来很漂亮。这里有一个快速的学习<a href="https://www.analyticsvidhya.com/blog/2016/03/questions-ggplot2-package-r/" target="_blank" rel="external">ggplots</a>的指南。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(ggplot2)</div><div class="line"><span class="comment">#Age vs Gender</span></div><div class="line">ggplot(combin, aes(Age, fill = Gender)) + geom_bar()</div></pre></td></tr></table></figure></p>
<p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2016/05/23.png" alt="image"><br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Age vs City_Category</span></div><div class="line">ggplot(combin, aes(Age, fill = City_Category)) + geom_bar()</div></pre></td></tr></table></figure></p>
<p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2016/05/24.png" alt="image"></p>
<p>我们还可以创建交叉表来分析分类变量。为了创建交叉表，我们将使用创建全面交叉表的包gmodel。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(gmodels)</div><div class="line">CrossTable(combin$Occupation, combin$City_Category)</div></pre></td></tr></table></figure></p>
<p>有了这两个变量，您就可以获得一个长时间的全面交叉表。类似地，您可以在最后分析其他变量。我们的二元分析并没有给我们提供很多可操作的见解。不管怎样，我们现在要进行数据处理。</p>
<h2 id="使用data-table处理数据"><a href="#使用data-table处理数据" class="headerlink" title="使用data.table处理数据"></a>使用data.table处理数据</h2><p>在这一部分中，我们将创建新的变量，重新评估现有变量，并处理缺失的值。简而言之，我们将为建模阶段准备好数据。<br>让我们从缺少的值开始。我们看到产品类别和产品类别有很多缺失值。对我来说，这暗示了一个隐藏的趋势，它可以通过创建一个新的变量来映射。因此，我们将创建一个新的变量，将NAs作为1和非NAs，在变量product类别2和product类别3中捕获。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#create a new variable for missing values</span></div><div class="line">combin[,Product_Category_2_NA := ifelse(sapply(combin$Product_Category_2, is.na) ==    <span class="literal">TRUE</span>,<span class="number">1</span>,<span class="number">0</span>)]</div><div class="line">combin[,Product_Category_3_NA := ifelse(sapply(combin$Product_Category_3, is.na) ==  <span class="literal">TRUE</span>,<span class="number">1</span>,<span class="number">0</span>)]</div></pre></td></tr></table></figure></p>
<p>现在让我们用任意的数字来估算缺失的值。让我们取-999<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#impute missing values</span></div><div class="line">combin[,Product_Category_2 := ifelse(is.na(Product_Category_2) == <span class="literal">TRUE</span>, <span class="string">"-999"</span>,  Product_Category_2)]</div><div class="line">combin[,Product_Category_3 := ifelse(is.na(Product_Category_3) == <span class="literal">TRUE</span>, <span class="string">"-999"</span>,  Product_Category_3)]</div></pre></td></tr></table></figure></p>
<p>在继续进行特性工程之前，我们将从单变量分析中重新评估变量的值。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#set column level</span></div><div class="line">levels(combin$Stay_In_Current_City_Years)[levels(combin$Stay_In_Current_City_Years) ==  <span class="string">"4+"</span>] &lt;- <span class="string">"4"</span></div><div class="line"><span class="comment">#recoding age groups</span></div><div class="line">levels(combin$Age)[levels(combin$Age) == <span class="string">"0-17"</span>] &lt;- <span class="number">0</span></div><div class="line">levels(combin$Age)[levels(combin$Age) == <span class="string">"18-25"</span>] &lt;- <span class="number">1</span></div><div class="line">levels(combin$Age)[levels(combin$Age) == <span class="string">"26-35"</span>] &lt;- <span class="number">2</span></div><div class="line">levels(combin$Age)[levels(combin$Age) == <span class="string">"36-45"</span>] &lt;- <span class="number">3</span></div><div class="line">levels(combin$Age)[levels(combin$Age) == <span class="string">"46-50"</span>] &lt;- <span class="number">4</span></div><div class="line">levels(combin$Age)[levels(combin$Age) == <span class="string">"51-55"</span>] &lt;- <span class="number">5</span></div><div class="line">levels(combin$Age)[levels(combin$Age) == <span class="string">"55+"</span>] &lt;- <span class="number">6</span></div><div class="line"><span class="comment">#convert age to numeric</span></div><div class="line">combin$Age &lt;- as.numeric(combin$Age)</div><div class="line"><span class="comment">#convert Gender into numeric</span></div><div class="line">combin[, Gender := as.numeric(as.factor(Gender)) - <span class="number">1</span>]</div></pre></td></tr></table></figure></p>
<p>为了建模目的，将因子变量转换为数值或整数是明智的。</p>
<p>现在让我们一步一步来，创建更多新的变量a.k.a特性工程。</p>
<p>在单变量分析中，我们发现ID变量的惟一值与数据集中的总观察值相比要小一些，这意味着用户ID或productid必须多次出现在这个数据集中。</p>
<p>让我们创建一个新变量来捕获这些ID变量的计数。较高的用户数量表明，某个特定用户已经多次购买产品。高产品数量表明，一款产品已经被多次购买，这表明它的受欢迎程度。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#User Count</span></div><div class="line">combin[, User_Count := .N, by = User_ID]</div><div class="line"><span class="comment">#Product Count</span></div><div class="line">combin[, Product_Count := .N, by = Product_ID]</div></pre></td></tr></table></figure></p>
<p>同样，我们可以计算一个产品的平均购买价格。因为，购买价格越低，就越有可能被买到，反之亦然。类似地，我们可以创建另一个变量，该变量将用户的平均购买价格映射到用户的购买价格(平均)。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Mean Purchase of Product</span></div><div class="line">combin[, Mean_Purchase_Product := mean(Purchase), by = Product_ID]</div><div class="line"><span class="comment">#Mean Purchase of User</span></div><div class="line">combin[, Mean_Purchase_User := mean(Purchase), by = User_ID]</div></pre></td></tr></table></figure></p>
<p>现在，我们只剩下一个关于city_category变量的热编码。这可以用dummies库来完成。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(dummies)</div><div class="line">combin &lt;- dummy.data.frame(combin, names = c(<span class="string">"City_Category"</span>), sep = <span class="string">"_"</span>)</div></pre></td></tr></table></figure></p>
<p>在继续进行建模阶段之前，让我们检查一下变量的数据类型，并在必要时进行必要的更改。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#check classes of all variables</span></div><div class="line">sapply(combin, class)</div><div class="line"><span class="comment">#converting Product Category 2 &amp; 3</span></div><div class="line">combin$Product_Category_2 &lt;- as.integer(combin$Product_Category_2)</div><div class="line">combin$Product_Category_3 &lt;- as.integer(combin$Product_Category_3)</div></pre></td></tr></table></figure></p>
<h2 id="使用H2O建模"><a href="#使用H2O建模" class="headerlink" title="使用H2O建模"></a>使用H2O建模</h2><p>在这一节中，我们将探讨在H2O中不同机器学习算法的力量。我们将构建带有回归、随机森林、GBM和深度学习的模型。</p>
<p>确保你不会像一个黑盒子那样使用这些算法。最好知道它们是如何工作的。这将帮助您理解构建这些模型所使用的参数。以下是学习这些算法的一些有用的资源:</p>
<ol>
<li>回归</li>
<li>随机森林，GBM</li>
<li>深度学习</li>
</ol>
<p>但是,先做重要的事。让我们把数据集分成测试集和训练集。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Divide into train and test</span></div><div class="line">c.train &lt;- combin[<span class="number">1</span>:nrow(train),]</div><div class="line">c.test &lt;- combin[-(<span class="number">1</span>:nrow(train)),]</div></pre></td></tr></table></figure></p>
<p>正如在开始时所发现的，在火车上的变量产品类别有一些噪声。让我们通过在产品类别1-18中选择所有行来删除它，从而删除类别为19和20的水平。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">c.train &lt;- c.train[c.train$Product_Category_1 &lt;= <span class="number">18</span>,]</div></pre></td></tr></table></figure></p>
<p>现在，我们的数据集已经准备好进行建模了。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">localH2O &lt;- h2o.init(nthreads = -<span class="number">1</span>)</div></pre></td></tr></table></figure></p>
<p>这个命令告诉H2O要使用机器上的所有cpu，这是推荐的。对于较大的数据集(比如1,000,000行)，H2O建议在具有高内存的服务器上运行集群，以获得最佳性能。一旦实例成功启动，您还可以使用下面的代码查看他的状态:<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">h2o.init()</div></pre></td></tr></table></figure></p>
<p>现在让我们将数据从R转移到H2O实例。它可以用as来完成H2O的命令。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#data to h2o cluster</span></div><div class="line">train.h2o &lt;- as.h2o(c.train)</div><div class="line">test.h2o &lt;- as.h2o(c.test)</div></pre></td></tr></table></figure></p>
<p>使用列索引，我们需要识别在建模中使用的变量:<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#check column index number</span></div><div class="line">colnames(train.h2o)</div><div class="line"> [<span class="number">1</span>] <span class="string">"User_ID"</span>                    <span class="string">"Product_ID"</span>                 <span class="string">"Gender"</span>                    </div><div class="line"> [<span class="number">4</span>] <span class="string">"Age"</span>                        <span class="string">"Occupation"</span>                 <span class="string">"City_Category_A"</span>           </div><div class="line"> [<span class="number">7</span>] <span class="string">"City_Category_B"</span>            <span class="string">"City_Category_C"</span>            <span class="string">"Stay_In_Current_City_Years"</span></div><div class="line">[<span class="number">10</span>] <span class="string">"Marital_Status"</span>             <span class="string">"Product_Category_1"</span>         <span class="string">"Product_Category_2"</span>        </div><div class="line">[<span class="number">13</span>] <span class="string">"Product_Category_3"</span>         <span class="string">"Purchase"</span>                   <span class="string">"Product_Category_2_NA"</span>     </div><div class="line">[<span class="number">16</span>] <span class="string">"Product_Category_3_NA"</span>      <span class="string">"User_Count"</span>                 <span class="string">"Product_Count"</span>             </div><div class="line">[<span class="number">19</span>] <span class="string">"Mean_Purchase_Product"</span>      <span class="string">"Mean_Purchase_User"</span></div></pre></td></tr></table></figure></p>
<p>让我们从多元线性回归模型开始。</p>
<h3 id="H2O中的多元线性回归"><a href="#H2O中的多元线性回归" class="headerlink" title="H2O中的多元线性回归"></a>H2O中的多元线性回归</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">regression.model &lt;- h2o.glm( y = y.dep, x = x.indep, training_frame = train.h2o, family = <span class="string">"gaussian"</span>)</div><div class="line">  |==================================================================================================| <span class="number">100</span>%</div><div class="line">h2o.performance(regression.model)</div><div class="line">H2ORegressionMetrics: glm</div><div class="line">** Reported on training data. **</div><div class="line">MSE:  <span class="number">16710563</span></div><div class="line">RMSE:  <span class="number">4087.856</span></div><div class="line">MAE:  <span class="number">3219.644</span></div><div class="line">RMSLE:  <span class="number">0.5782911</span></div><div class="line">Mean Residual Deviance :  <span class="number">16710563</span></div><div class="line">R^<span class="number">2</span> :  <span class="number">0.3261543</span></div><div class="line">Null Deviance :<span class="number">1.353804e+13</span></div><div class="line">Null D.o.F. :<span class="number">545914</span></div><div class="line">Residual Deviance :<span class="number">9.122547e+12</span></div><div class="line">Residual D.o.F. :<span class="number">545898</span></div><div class="line">AIC :<span class="number">10628689</span></div></pre></td></tr></table></figure>
<p>H2O的GLM算法适用于各种类型的回归，如lasso、bridge、逻辑、线性等。用户只需要对family参数进行相应的修改。例如:要做逻辑回归，你可以改写成family=“binomial”。</p>
<p>因此，在我们打印了模型结果之后，我们看到，回归给出了一个可怜的R值，即0.326。它的意思是，依赖变量中只有32.6%的变量是由独立变量来解释的，而剩下的是无法解释的。这表明，回归模型无法捕获非线性关系。</p>
<p>出于好奇，让我们看看这个模型的预测。它会比平均预测更糟糕吗?<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#make predictions</span></div><div class="line">predict.reg &lt;- as.data.frame(h2o.predict(regression.model, test.h2o))</div><div class="line">sub_reg &lt;- data.frame(User_ID = test$User_ID, Product_ID = test$Product_ID, Purchase =  predict.reg$predict)</div><div class="line">write.csv(sub_reg, file = <span class="string">"sub_reg.csv"</span>, row.names = <span class="literal">F</span>)</div></pre></td></tr></table></figure></p>
<p>让我们上传解决方案文件(压缩格式)，检查我们是否有一些改进。</p>
<p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2016/05/25-1024x304.png" alt="image"></p>
<p>哇!我们的预测分数有所提高。我们从4982.31开始，随着回归，我们比以前的分数有了进步。在排行榜上，这份报告让我排到了第129位。</p>
<p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2016/05/26-1024x141.png" alt="image"></p>
<p>如果我们选择一种能很好地映射非线性关系的算法，我们就能做得很好。随机森林是我们的下一个赌注。</p>
<h3 id="H2O中的随机森林"><a href="#H2O中的随机森林" class="headerlink" title="H2O中的随机森林"></a>H2O中的随机森林</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Random Forest</span></div><div class="line">system.time(</div><div class="line">  rforest.model &lt;- h2o.randomForest(y=y.dep, x=x.indep, training_frame = train.h2o, ntrees = <span class="number">1000</span>, mtries = <span class="number">3</span>, max_depth = <span class="number">4</span>, seed = <span class="number">1122</span>)</div><div class="line">)</div></pre></td></tr></table></figure>
<p>在1000棵树的情况下，随机森林模型大约需要104秒的运行时间。它以100%的CPU容量运行，可以在任务管理器中看到。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">h2o.performance(rforest.model)</div><div class="line">H2ORegressionMetrics: drf</div><div class="line">** Reported on training data. **</div><div class="line">** Metrics reported on Out-Of-Bag training samples **</div><div class="line">MSE:  <span class="number">10414919</span></div><div class="line">RMSE:  <span class="number">3227.215</span></div><div class="line">MAE:  <span class="number">2486.118</span></div><div class="line">RMSLE:  <span class="number">0.5007453</span></div><div class="line">Mean Residual Deviance :  <span class="number">10414919</span></div><div class="line"><span class="comment">#check variable importance</span></div><div class="line">h2o.varimp(rforest.model)</div><div class="line">Variable Importances: </div><div class="line">                     variable     relative_importance scaled_importance percentage</div><div class="line"><span class="number">1</span>       Mean_Purchase_Product <span class="number">2720452686381056.000000</span>          <span class="number">1.000000</span>   <span class="number">0.573797</span></div><div class="line"><span class="number">2</span>          Product_Category_1 <span class="number">1005997304840192.000000</span>          <span class="number">0.369790</span>   <span class="number">0.212185</span></div><div class="line"><span class="number">3</span>               Product_Count  <span class="number">252741091852288.000000</span>          <span class="number">0.092904</span>   <span class="number">0.053308</span></div><div class="line"><span class="number">4</span>          Product_Category_3  <span class="number">231408274505728.000000</span>          <span class="number">0.085062</span>   <span class="number">0.048809</span></div><div class="line"><span class="number">5</span>       Product_Category_3_NA  <span class="number">194243133964288.000000</span>          <span class="number">0.071401</span>   <span class="number">0.040970</span></div><div class="line"><span class="number">6</span>          Mean_Purchase_User  <span class="number">174858721820672.000000</span>          <span class="number">0.064276</span>   <span class="number">0.036881</span></div><div class="line"><span class="number">7</span>          Product_Category_2   <span class="number">84932466573312.000000</span>          <span class="number">0.031220</span>   <span class="number">0.017914</span></div><div class="line"><span class="number">8</span>       Product_Category_2_NA   <span class="number">54471002423296.000000</span>          <span class="number">0.020023</span>   <span class="number">0.011489</span></div><div class="line"><span class="number">9</span>                  User_Count   <span class="number">12314694647808.000000</span>          <span class="number">0.004527</span>   <span class="number">0.002597</span></div><div class="line"><span class="number">10</span>            City_Category_C    <span class="number">5007590031360.000000</span>          <span class="number">0.001841</span>   <span class="number">0.001056</span></div><div class="line"><span class="number">11</span>                     Gender    <span class="number">2175469223936.000000</span>          <span class="number">0.000800</span>   <span class="number">0.000459</span></div><div class="line"><span class="number">12</span>            City_Category_A    <span class="number">1162100736000.000000</span>          <span class="number">0.000427</span>   <span class="number">0.000245</span></div><div class="line"><span class="number">13</span>                        Age     <span class="number">613729370112.000000</span>          <span class="number">0.000226</span>   <span class="number">0.000129</span></div><div class="line"><span class="number">14</span>                 Occupation     <span class="number">478127718400.000000</span>          <span class="number">0.000176</span>   <span class="number">0.000101</span></div><div class="line"><span class="number">15</span>            City_Category_B     <span class="number">234770481152.000000</span>          <span class="number">0.000086</span>   <span class="number">0.000050</span></div><div class="line"><span class="number">16</span> Stay_In_Current_City_Years      <span class="number">32139771904.000000</span>          <span class="number">0.000012</span>   <span class="number">0.000007</span></div><div class="line"><span class="number">17</span>             Marital_Status      <span class="number">17185155072.000000</span>          <span class="number">0.000006</span>   <span class="number">0.000004</span></div></pre></td></tr></table></figure></p>
<p>让我们通过做预测来检查这个模型的排行榜。你认为我们的分数会提高吗?不过，我还是报点希望。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#making predictions on unseen data</span></div><div class="line">system.time(predict.rforest &lt;- as.data.frame(h2o.predict(rforest.model, test.h2o)))</div><div class="line">  |==================================================================================================| <span class="number">100</span>%</div><div class="line"> 用户  系统  流逝 </div><div class="line"> <span class="number">0.56</span>  <span class="number">0.06</span> <span class="number">22.17</span> </div><div class="line"><span class="comment">#writing submission file</span></div><div class="line">sub_rf &lt;- data.frame(User_ID = test$User_ID, Product_ID = test$Product_ID, Purchase =  predict.rforest$predict)</div><div class="line">write.csv(sub_rf, file = <span class="string">"sub_rf.csv"</span>, row.names = <span class="literal">F</span>)</div></pre></td></tr></table></figure></p>
<p>做出预测需要22秒。现在是上传提交文件并检查结果的时候了。</p>
<p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2016/05/27-1024x290.png" alt="image"></p>
<p>这在排行榜上略有改善，但没有预期的那么好。可以再试试GBM，一种增强算法也许可以有所帮助。</p>
<h3 id="H2O中的GBM"><a href="#H2O中的GBM" class="headerlink" title="H2O中的GBM"></a>H2O中的GBM</h3><p>如果您是GBM的新手，我建议您检查本节开始时给出的参考资料。我们可以在H2O中使用简单的代码行来实现GBM:<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#GBM</span></div><div class="line">system.time(</div><div class="line">  gbm.model &lt;- h2o.gbm(y=y.dep, x=x.indep, training_frame = train.h2o, ntrees = <span class="number">1000</span>, max_depth = <span class="number">4</span>, learn_rate = <span class="number">0.01</span>, seed = <span class="number">1122</span>)</div><div class="line">)</div><div class="line">|==================================================================================================| <span class="number">100</span>%</div><div class="line">  用户   系统   流逝 </div><div class="line">  <span class="number">3.33</span>   <span class="number">0.15</span> <span class="number">298.91</span></div></pre></td></tr></table></figure></p>
<p>使用相同数量的树，GBM花费的时间比随机的森林多。花了299秒。您可以使用这个模型来检查这个模型的性能:<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">h2o.performance (gbm.model)</div><div class="line">H2ORegressionMetrics: gbm</div><div class="line">** Reported on training data. **</div><div class="line">MSE:  <span class="number">6321280</span></div><div class="line">RMSE:  <span class="number">2514.216</span></div><div class="line">MAE:  <span class="number">1859.895</span></div><div class="line">RMSLE:  <span class="literal">NaN</span></div><div class="line">Mean Residual Deviance :  <span class="number">6321280</span></div></pre></td></tr></table></figure></p>
<p>正如您所看到的，与前两个模型相比，我们的R方已经有了很大的改进。这显示了一个强大的模式的迹象。让我们做个预测，看看这个模型是否能给我们带来一些改进。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#making prediction and writing submission file</span></div><div class="line">predict.gbm &lt;- as.data.frame(h2o.predict(gbm.model, test.h2o))</div><div class="line">sub_gbm &lt;- data.frame(User_ID = test$User_ID, Product_ID = test$Product_ID, Purchase = predict.gbm$predict)</div><div class="line">write.csv(sub_gbm, file = <span class="string">"sub_gbm.csv"</span>, row.names = <span class="literal">F</span>)</div></pre></td></tr></table></figure></p>
<p>我们已经创建了提交文件。让我们上传它，看看我们是否有任何改进。</p>
<p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2016/05/29-1024x286.png" alt="image"></p>
<p>我从来没有怀疑过GBM。如果做得好，增加算法通常会得到很好的回报。现在，我将会很有趣地看到我的排行榜:</p>
<p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2016/05/30-1024x111.png" alt="image"></p>
<p>这是一个巨大的排行榜的飞跃！它就像一个自由落体但安全着陆从第122位到第25位。我们能做得更好吗?也许,我们可以。现在让我们在H2O中使用深度学习算法来提高这个分数。</p>
<h3 id="H2O中的深度学习"><a href="#H2O中的深度学习" class="headerlink" title="H2O中的深度学习"></a>H2O中的深度学习</h3><p>让我简要地概述一下深度学习。在深度学习算法中，存在3层，即输入层、隐藏层和输出层。它的工作原理如下:</p>
<ol>
<li>我们将数据输入到输入层。</li>
<li>然后，它将数据传输到隐藏层。这些隐藏的层由神经元组成。这些神经元使用一些功能，并协助在变量之间绘制非线性关系。隐藏的层是用户指定的。</li>
<li>最后，这些隐藏层将输出到输出层，然后输出结果。</li>
</ol>
<p>现在我们来实现这个算法。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#deep learning models</span></div><div class="line">system.time(</div><div class="line">  dlearning.model &lt;- h2o.deeplearning(y = y.dep,</div><div class="line">                                      x = x.indep,</div><div class="line">                                      training_frame = train.h2o,</div><div class="line">                                      epoch = <span class="number">60</span>,</div><div class="line">                                      hidden = c(<span class="number">100</span>,<span class="number">100</span>),</div><div class="line">                                      activation = <span class="string">"Rectifier"</span>,</div><div class="line">                                      seed = <span class="number">1122</span></div><div class="line">  )</div><div class="line">)</div><div class="line">|==================================================================================================| <span class="number">100</span>%</div><div class="line">  用户   系统   流逝 </div><div class="line">  <span class="number">1.06</span>   <span class="number">0.07</span> <span class="number">167.21</span></div></pre></td></tr></table></figure></p>
<p>它的执行速度比GBM模型要快。GBM用了约 167秒。隐藏的参数指示这些算法创建每一个隐藏的100个神经元的隐藏层。epoch 负责训练数据的传递的数量。Activation 指的是在整个网络中使用的激活函数。不管怎样，让我们检查一下它的性能。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&gt; h2o.performance(dlearning.model)</div><div class="line">H2ORegressionMetrics: deeplearning</div><div class="line">** Reported on training data. **</div><div class="line">** Metrics reported on temporary training frame with <span class="number">9881</span> samples **</div><div class="line">MSE:  <span class="number">6171467</span></div><div class="line">RMSE:  <span class="number">2484.244</span></div><div class="line">MAE:  <span class="number">1832.876</span></div><div class="line">RMSLE:  <span class="literal">NaN</span></div><div class="line">Mean Residual Deviance :  <span class="number">6171467</span></div></pre></td></tr></table></figure></p>
<p>与GBM模型相比，我们可以看到R方度量的进一步改进。这表明，深度学习模型已经成功地捕获了模型中大量无法解释的差异。我们来做一下预测，看看最终的分数。<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#making predictions</span></div><div class="line">predict.dl2 &lt;- as.data.frame(h2o.predict(dlearning.model, test.h2o))</div><div class="line"><span class="comment">#create a data frame and writing submission file</span></div><div class="line">sub_dlearning &lt;- data.frame(User_ID = test$User_ID, Product_ID = test$Product_ID, Purchase = predict.dl2$predict)</div><div class="line">write.csv(sub_dlearning, file = <span class="string">"sub_dlearning_new.csv"</span>, row.names = <span class="literal">F</span>)</div></pre></td></tr></table></figure></p>
<p>让我们上传最后的提交，并检查分数。</p>
<p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2016/05/32-1024x283.png" alt="image"></p>
<p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2016/05/33-1024x105.png" alt="image"></p>
<p>虽然我的分数有所提高，但排名没有。最后，我们通过使用一些特性工程和机器学习算法，最终达到了第25位。我希望你从第154位到第25位的旅程很愉快。如果你一直跟着我到这里，我想你已经准备好再走一步了。</p>
<h3 id="下一步怎样改进模型"><a href="#下一步怎样改进模型" class="headerlink" title="下一步怎样改进模型"></a>下一步怎样改进模型</h3><p>实际上，你可以做很多事情。在这里，我把它们列出来:</p>
<ol>
<li>在GBM、深度学习和随机森林中进行参数调优。</li>
<li>使用grid搜索进行参数调优。H2O有一个很好的H2O。完成这个任务的grid</li>
<li>考虑创建更多的特性，这些特性可以为模型带来新的信息。</li>
<li>最后，综合所有的结果以获得一个更好的模型。</li>
</ol>
<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>我希望你能享受这次使用data.table和H2O的数据探索经历。一旦你熟练使用这两个包，你就可以避免由于内存问题而产生的许多障碍。在本文中，我讨论了使用data.table和H2O实现模型构建的步骤(使用R代码)。虽然，H2O本身可以进行数据处理任务，但我相信data.table是一个非常容易使用的(语法)选项。</p>
<p>在本文中，我的目的是让您开始使用data.table和H2O构建模型。我相信，在这种建模实践之后，您将会变得很有兴趣进一步了解这些包。</p>
<p>这篇文章让你学到了新的东西吗?请在评论中写下你的建议、经验或任何反馈，这些都能让我以更好的方式帮助你。</p>
<p>译自：<a href="https://www.analyticsvidhya.com/blog/2016/05/h2o-data-table-build-models-large-data-sets/" target="_blank" rel="external">https://www.analyticsvidhya.com/blog/2016/05/h2o-data-table-build-models-large-data-sets/</a></p>
</div><div class="tags"><a href="/tags/大数据/">大数据</a><a href="/tags/H2O/">H2O</a></div><div class="post-share"><div class="jiathis_style"><span class="jiathis_txt">分享到：</span><a class="jiathis_button_tsina"></a><a class="jiathis_button_qzone"></a><a class="jiathis_button_weixin"></a><a class="jiathis_button_fb"></a><a class="jiathis_button_linkedin"></a><a class="jiathis_button_twitter"></a><a class="jiathis_button_ydnote"></a><a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis"></a><a class="jiathis_counter_style"></a></div></div><div class="post-nav"><a href="/2017/11/26/data.table() vs data.frame() – R大数据集处理/" class="next">data.table() vs data.frame() – R大数据集处理</a></div><div id="comments"><div id="uyan_frame"></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#引文"><span class="toc-text">引文</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#目录"><span class="toc-text">目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#H2O简介"><span class="toc-text">H2O简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么它如此快"><span class="toc-text">为什么它如此快</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实战开始"><span class="toc-text">实战开始</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用data-table和ggplot进行数据探索"><span class="toc-text">使用data.table和ggplot进行数据探索</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用data-table处理数据"><span class="toc-text">使用data.table处理数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用H2O建模"><span class="toc-text">使用H2O建模</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#H2O中的多元线性回归"><span class="toc-text">H2O中的多元线性回归</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#H2O中的随机森林"><span class="toc-text">H2O中的随机森林</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#H2O中的GBM"><span class="toc-text">H2O中的GBM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#H2O中的深度学习"><span class="toc-text">H2O中的深度学习</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#下一步怎样改进模型"><span class="toc-text">下一步怎样改进模型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#结束语"><span class="toc-text">结束语</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/11/30/使用H2O和data.table构建R大数据集模型/">使用H2O和data.table构建R大数据集模型</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/26/data.table() vs data.frame() – R大数据集处理/">data.table() vs data.frame() – R大数据集处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/20/实战Caret包对借贷数据进行机器学习预测/">实战Caret包对借贷数据进行机器学习预测</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/15/使用rvest抓取NBA历史比赛数据/">使用rvest抓取NBA历史比赛数据</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/10/译：机器学习算法要点（附Python和R代码）/">译：机器学习算法要点（附Python和R代码）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/23/侦测欺诈交易/">侦测欺诈交易</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/18/购物篮关联规则分析/">购物篮关联规则分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/01/R中如何对量化策略进行回测/">R中如何对量化策略进行回测</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/11/R中的大数据分析/">R中的大数据分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/11/R机器学习之股票预测初探/">R机器学习之股票预测初探</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Python-R/">Python + R</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/R/">R</a><span class="category-list-count">9</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/数据预处理/" style="font-size: 15px;">数据预处理</a> <a href="/tags/量化金融/" style="font-size: 15px;">量化金融</a> <a href="/tags/大数据/" style="font-size: 15px;">大数据</a> <a href="/tags/聚类/" style="font-size: 15px;">聚类</a> <a href="/tags/线性回归/" style="font-size: 15px;">线性回归</a> <a href="/tags/股票预测/" style="font-size: 15px;">股票预测</a> <a href="/tags/机器学习/" style="font-size: 15px;">机器学习</a> <a href="/tags/特征选取/" style="font-size: 15px;">特征选取</a> <a href="/tags/H2O/" style="font-size: 15px;">H2O</a> <a href="/tags/欺诈侦测/" style="font-size: 15px;">欺诈侦测</a> <a href="/tags/半监督分类/" style="font-size: 15px;">半监督分类</a> <a href="/tags/类失衡/" style="font-size: 15px;">类失衡</a> <a href="/tags/贝叶斯分类器/" style="font-size: 15px;">贝叶斯分类器</a> <a href="/tags/AdaBoost分类器/" style="font-size: 15px;">AdaBoost分类器</a> <a href="/tags/决策精确度/" style="font-size: 15px;">决策精确度</a> <a href="/tags/回溯精确度/" style="font-size: 15px;">回溯精确度</a> <a href="/tags/交叉验证/" style="font-size: 15px;">交叉验证</a> <a href="/tags/离群值侦测排序/" style="font-size: 15px;">离群值侦测排序</a> <a href="/tags/网络爬虫/" style="font-size: 15px;">网络爬虫</a> <a href="/tags/Caret预测/" style="font-size: 15px;">Caret预测</a> <a href="/tags/回测/" style="font-size: 15px;">回测</a> <a href="/tags/数据分割/" style="font-size: 15px;">数据分割</a> <a href="/tags/特征选择/" style="font-size: 15px;">特征选择</a> <a href="/tags/参数调优/" style="font-size: 15px;">参数调优</a> <a href="/tags/变量重要性评估/" style="font-size: 15px;">变量重要性评估</a> <a href="/tags/逻辑回归/" style="font-size: 15px;">逻辑回归</a> <a href="/tags/决策树/" style="font-size: 15px;">决策树</a> <a href="/tags/支持向量机/" style="font-size: 15px;">支持向量机</a> <a href="/tags/朴素贝叶斯/" style="font-size: 15px;">朴素贝叶斯</a> <a href="/tags/最近邻（KNN）/" style="font-size: 15px;">最近邻（KNN）</a> <a href="/tags/K-均值/" style="font-size: 15px;">K-均值</a> <a href="/tags/随机森林/" style="font-size: 15px;">随机森林</a> <a href="/tags/降维算法/" style="font-size: 15px;">降维算法</a> <a href="/tags/梯度下降算法/" style="font-size: 15px;">梯度下降算法</a> <a href="/tags/GBM/" style="font-size: 15px;">GBM</a> <a href="/tags/XGBoost/" style="font-size: 15px;">XGBoost</a> <a href="/tags/LightGBM/" style="font-size: 15px;">LightGBM</a> <a href="/tags/CatBoost/" style="font-size: 15px;">CatBoost</a> <a href="/tags/购物篮/" style="font-size: 15px;">购物篮</a> <a href="/tags/关联规则/" style="font-size: 15px;">关联规则</a> <a href="/tags/推荐算法/" style="font-size: 15px;">推荐算法</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="http://weibo.com/youthcolor" title="Geekdreams" target="_blank">Geekdreams</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">youthcolor.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>var jiathis_config={
    data_track_clickback:true,
    summary:"",
    shortUrl:true,
    hideMore:false
}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script><script src="http://v2.uyan.cc/code/uyan.js?uid=2136627"></script></body></html>